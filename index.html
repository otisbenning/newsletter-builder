<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Start with a Friend Newsletter Builder</title>
    
    <!-- Cropper.js CDN -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.js"></script>
    
    <style>
        /* Reset und Basis-Styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            --primary-color: #009a93;
            --secondary-color: #00989a;
            --accent-color: #c5003d;
            --dark-color: #213293;
            font-family: 'GT Walsheim', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
            background-color: #f5f5f5;
            height: 100vh;
            overflow: hidden;
        }

        /* App Container */
        .app-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            background-color: white;
        }

        /* Header */
        header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        header h1 {
            font-size: 20px;
            font-weight: 600;
            display: flex;
            align-items: center;
        }

        .app-logo {
            height: 36px;
            margin-right: 10px;
            filter: brightness(0) invert(1);
        }

        .header-buttons {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .header-buttons button {
            padding: 8px 16px;
            background-color: rgba(255,255,255,0.2);
            color: white;
            border: 1px solid rgba(255,255,255,0.3);
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s;
        }

        .header-buttons button:hover {
            background-color: rgba(255,255,255,0.3);
            transform: translateY(-2px);
        }

        .header-button-separator {
            width: 1px;
            height: 24px;
            background-color: rgba(255,255,255,0.3);
            margin: 0 8px;
        }

        /* Main Content */
        .main-content {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        /* Sidebar */
        .sidebar {
            width: 280px;
            background-color: #f8f9fa;
            border-right: 1px solid #e0e0e0;
            padding: 20px;
            overflow-y: auto;
        }

        .sidebar h3 {
            font-size: 14px;
            color: #666;
            text-transform: uppercase;
            margin-bottom: 15px;
            font-weight: 600;
        }

        .module {
            background-color: white;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 10px;
            cursor: move;
            transition: all 0.3s;
            position: relative;
        }

        .module:hover {
            border-color: var(--primary-color);
            transform: translateX(5px);
            box-shadow: 0 2px 8px rgba(0,153,147,0.2);
        }

        .module-drag-handle {
            position: absolute;
            left: 8px;
            top: 50%;
            transform: translateY(-50%);
            color: #999;
        }

        .module-drag-handle::after {
            content: "‚â°";
        }

        .module-title {
            margin-left: 20px;
            font-weight: 500;
            color: #333;
        }

        /* Template Editor */
        .template-editor {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .template-header {
            background-color: white;
            padding: 15px 20px;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        #templateTitle {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        /* Preview Area */
        .preview-area {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background: linear-gradient(to bottom, #f9f9f9, #ffffff);
        }

        .preview-content {
            max-width: 800px;
            margin: 0 auto;
            background-color: white;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
            min-height: 100%;
        }

        /* Template Module */
        .template-module {
            position: relative;
            margin: 16px 0;
            border: 1px solid #ddd;
            border-radius: 6px;
            background-color: white;
            transition: all 0.2s;
        }

        .template-module:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            border-color: var(--primary-color);
        }

        .module-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 16px;
            background-color: #f8f9fa;
            border-bottom: 1px solid #ddd;
            border-radius: 6px 6px 0 0;
            cursor: move;
        }

        .module-actions {
            display: flex;
            gap: 6px;
        }

        .module-actions button {
            padding: 4px 8px;
            font-size: 12px;
            border: 1px solid #ddd;
            background: white;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .module-actions button:hover {
            background-color: #f0f0f0;
        }

        .move-up, .move-down {
            color: #666;
            padding: 4px 6px !important;
            font-size: 16px !important;
        }

        .edit-module {
            color: #0066cc;
        }

        .duplicate-module {
            color: #28a745;
        }

        .delete-module {
            color: #dc3545;
        }

        .module-content {
            padding: 16px;
        }

        /* Editor Actions */
        .editor-actions {
            padding: 12px 16px;
            border-top: 1px solid #e5e5e5;
            display: flex;
            justify-content: space-between;
            gap: 10px;
            background-color: white;
        }

        /* Buttons */
        .primary-btn {
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 6px;
            padding: 10px 20px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .primary-btn:hover {
            background-color: #007a73;
            transform: translateY(-2px);
        }

        .secondary-btn {
            background-color: white;
            color: var(--primary-color);
            border: 1px solid var(--primary-color);
            border-radius: 6px;
            padding: 10px 20px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .secondary-btn:hover {
            background-color: var(--primary-color);
            color: white;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            z-index: 1001;
            max-width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-content {
            padding: 24px;
            min-width: 500px;
        }

        .modal-header {
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 1px solid #eee;
        }

        .modal h2 {
            color: var(--primary-color);
            font-size: 20px;
            font-weight: 600;
        }

        .modal-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
        }

        /* Field Groups */
        .field-group {
            margin-bottom: 20px;
        }

        .field-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            color: #333;
            font-size: 14px;
        }

        .field-group input,
        .field-group textarea,
        .field-group select {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            font-family: inherit;
        }

        .field-group textarea {
            min-height: 100px;
            resize: vertical;
        }

        /* Tabs */
        .module-editor-tabs {
            display: flex;
            border-bottom: 1px solid #ddd;
            margin-bottom: 20px;
        }

        .module-editor-tab {
            padding: 10px 20px;
            background: none;
            border: none;
            border-bottom: 2px solid transparent;
            cursor: pointer;
            font-weight: 500;
            color: #666;
            transition: all 0.2s;
        }

        .module-editor-tab.active {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
        }

        /* Dynamic Items List */
        .dynamic-items-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .event-card {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            position: relative;
        }

        .event-card-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 10px;
        }

        .event-date-box {
            background: var(--primary-color);
            color: white;
            padding: 8px;
            border-radius: 4px;
            text-align: center;
            min-width: 50px;
        }

        .event-date-month {
            font-size: 11px;
            text-transform: uppercase;
        }

        .event-date-day {
            font-size: 20px;
            font-weight: bold;
        }

        .event-badges {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
        }

        .badge {
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 500;
            color: white;
        }

        .badge-category {
            background: var(--secondary-color);
        }

        .badge-mode {
            background: var(--accent-color);
        }

        .badge-location {
            background: var(--dark-color);
        }

        /* Bookmarklet Box */
        .bookmarklet-box {
            background: #f8f9fa;
            border: 2px dashed var(--primary-color);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .bookmarklet-link {
            display: inline-block;
            background: var(--primary-color);
            color: white !important;
            padding: 15px 30px;
            border-radius: 6px;
            text-decoration: none;
            font-weight: bold;
            font-size: 16px;
            margin: 10px 0;
            cursor: move;
            box-shadow: 0 4px 12px rgba(0, 153, 147, 0.3);
            transition: all 0.3s;
            border: 3px solid var(--primary-color);
        }

        .bookmarklet-link:hover {
            background: #007a73;
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(0, 153, 147, 0.4);
        }

        .bookmarklet-link:active {
            transform: scale(0.98);
        }

        .bookmarklet-link:hover {
            background: #007a73;
        }

        /* Paste Events Box */
        .paste-events-box {
            border: 2px solid #ddd;
            border-radius: 4px;
            padding: 10px;
            margin: 15px 0;
            background: #f9f9f9;
        }

        .paste-events-textarea {
            width: 100%;
            min-height: 150px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            margin-bottom: 10px;
        }

        /* Copy HTML Box */
        .copy-html-box {
            background: #f0f0f0;
            padding: 10px;
            border-radius: 4px;
            margin-top: 10px;
        }

        .html-preview {
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 10px;
            max-height: 300px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 11px;
            white-space: pre-wrap;
            word-break: break-all;
            margin-bottom: 10px;
        }

        /* Image Upload */
        .image-upload-btn {
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 4px;
            padding: 8px 12px;
            cursor: pointer;
            font-weight: 500;
            transition: background-color 0.2s;
            margin-top: 10px;
        }

        .image-upload-btn:hover {
            background-color: #007a73;
        }

        .image-preview {
            margin-top: 10px;
            max-width: 200px;
            max-height: 100px;
            overflow: hidden;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .image-preview img {
            max-width: 100%;
            max-height: 100px;
            display: block;
        }

        /* Overlay */
        #overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
        }

        /* Notification */
        .notification {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 16px 20px;
            background-color: var(--primary-color);
            color: white;
            border-radius: 6px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            z-index: 2000;
            animation: slideIn 0.3s ease;
        }

        .notification.error {
            background-color: var(--accent-color);
        }

        .notification.success {
            background-color: #28a745;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* Drag & Drop */
        .dragging {
            opacity: 0.5;
        }

        .drag-over {
            border: 2px dashed var(--primary-color);
            background-color: rgba(0, 153, 147, 0.05);
        }

        /* Responsive */
        @media (max-width: 992px) {
            .main-content {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                max-height: 200px;
                border-right: none;
                border-bottom: 1px solid #e0e0e0;
            }
        }

        @media (max-width: 768px) {
            .header-buttons {
                flex-wrap: wrap;
                gap: 5px;
            }
            
            .modal-content {
                min-width: auto;
                width: 95vw;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <header>
            <h1>
                <img src="https://www.start-with-a-friend.de/wp-content/uploads/2023/05/start-with-a-friend-mobile-logo-1-ai-1.svg" 
                     alt="Start with a Friend" class="app-logo">
                Newsletter Builder
            </h1>
            <div class="header-buttons">
                <button id="newTemplateBtn" title="Neues Template">Neu</button>
                <button id="saveTemplateBtn" title="Template speichern">Speichern</button>
                <button id="loadTemplateBtn" title="Template laden">Laden</button>
                <div class="header-button-separator"></div>
                <button id="exportTemplateBtn" title="Als JSON exportieren">Export JSON</button>
                <button id="importTemplateBtn" title="JSON importieren">Import JSON</button>
                <div class="header-button-separator"></div>
                <button id="previewBtn" title="Vorschau">Vorschau</button>
                <button id="copyHTMLBtn" title="HTML kopieren">üìã HTML kopieren</button>
                <button id="helpBtn" title="Hilfe & Anleitung" style="background: #0066cc;">‚ùì Hilfe</button>
            </div>
        </header>

        <div class="main-content">
            <aside class="sidebar">
                <h3>Pflicht-Module</h3>
                <div class="modules-list">
                    <div class="module" draggable="true" data-module-type="preheader">
                        <span class="module-drag-handle"></span>
                        <span class="module-title">Preheader</span>
                    </div>
                    <div class="module" draggable="true" data-module-type="header">
                        <span class="module-drag-handle"></span>
                        <span class="module-title">Header (Logo)</span>
                    </div>
                    <div class="module" draggable="true" data-module-type="footer-imprint">
                        <span class="module-drag-handle"></span>
                        <span class="module-title">Footer/Impressum</span>
                    </div>
                    <div class="module" draggable="true" data-module-type="unsubscribe">
                        <span class="module-drag-handle"></span>
                        <span class="module-title">Abmelde-Link</span>
                    </div>
                </div>
                
                <h3 style="margin-top: 20px;">Inhalts-Module</h3>
                <div class="modules-list">
                    <div class="module" draggable="true" data-module-type="hero-image">
                        <span class="module-drag-handle"></span>
                        <span class="module-title">Hero Bild</span>
                    </div>
                    <div class="module" draggable="true" data-module-type="greeting">
                        <span class="module-drag-handle"></span>
                        <span class="module-title">Begr√º√üung</span>
                    </div>
                    <div class="module" draggable="true" data-module-type="image-text">
                        <span class="module-drag-handle"></span>
                        <span class="module-title">Bild & Text</span>
                    </div>
                    <div class="module" draggable="true" data-module-type="text-only">
                        <span class="module-drag-handle"></span>
                        <span class="module-title">Nur Text</span>
                    </div>
                    <div class="module" draggable="true" data-module-type="events">
                        <span class="module-drag-handle"></span>
                        <span class="module-title">Events</span>
                    </div>
                    <div class="module" draggable="true" data-module-type="two-columns">
                        <span class="module-drag-handle"></span>
                        <span class="module-title">Zwei Spalten</span>
                    </div>
                    <div class="module" draggable="true" data-module-type="three-columns">
                        <span class="module-drag-handle"></span>
                        <span class="module-title">Drei Spalten</span>
                    </div>
                    <div class="module" draggable="true" data-module-type="quote">
                        <span class="module-drag-handle"></span>
                        <span class="module-title">Zitat</span>
                    </div>
                    <div class="module" draggable="true" data-module-type="cta-section">
                        <span class="module-drag-handle"></span>
                        <span class="module-title">Call-to-Action</span>
                    </div>
                    <div class="module" draggable="true" data-module-type="button-center">
                        <span class="module-drag-handle"></span>
                        <span class="module-title">Button (zentriert)</span>
                    </div>
                    <div class="module" draggable="true" data-module-type="three-buttons">
                        <span class="module-drag-handle"></span>
                        <span class="module-title">Drei Buttons</span>
                    </div>
                    <div class="module" draggable="true" data-module-type="social-media">
                        <span class="module-drag-handle"></span>
                        <span class="module-title">Social Media</span>
                    </div>
                    <div class="module" draggable="true" data-module-type="contact-person">
                        <span class="module-drag-handle"></span>
                        <span class="module-title">Ansprechpartner</span>
                    </div>
                    <div class="module" draggable="true" data-module-type="partner-news">
                        <span class="module-drag-handle"></span>
                        <span class="module-title">Partner News</span>
                    </div>
                    <div class="module" draggable="true" data-module-type="divider">
                        <span class="module-drag-handle"></span>
                        <span class="module-title">Trennlinie</span>
                    </div>
                </div>
            </aside>

            <main class="template-editor">
                <div class="template-header">
                    <label for="templateTitle">Template Name:</label>
                    <input type="text" id="templateTitle" placeholder="Newsletter Template Name">
                </div>
                <div class="preview-area">
                    <div class="preview-content" id="previewContent">
                        <!-- Template modules will be added here -->
                        <div style="padding: 40px; text-align: center; color: #999;">
                            <p>Ziehen Sie Module aus der Seitenleiste hierher, um Ihr Template zu erstellen.</p>
                        </div>
                    </div>
                </div>
                <div class="editor-actions">
                    <div>
                        <button class="secondary-btn" id="clearTemplateBtn">Template leeren</button>
                    </div>
                    <div>
                        <button class="primary-btn" id="generateHTMLBtn">HTML als Datei exportieren</button>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Module Editor Modal -->
    <div id="moduleEditorModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="moduleEditorTitle">Modul bearbeiten</h2>
            </div>
            <div class="module-editor-tabs">
                <button class="module-editor-tab active" data-tab="content">Inhalt</button>
                <button class="module-editor-tab" data-tab="settings">Einstellungen</button>
            </div>
            <div id="moduleEditorContent">
                <!-- Dynamic content will be inserted here -->
            </div>
            <div class="modal-actions">
                <button class="secondary-btn" id="cancelModuleEdit">Abbrechen</button>
                <button class="primary-btn" id="saveModuleEdit">Speichern</button>
            </div>
        </div>
    </div>

    <!-- Event Import Modal -->
    <div id="eventImportModal" class="modal">
        <div class="modal-content" style="min-width: 600px;">
            <div class="modal-header">
                <h2>Events importieren</h2>
            </div>
            
            <div class="bookmarklet-box" style="background: #f8f9fa; border: 2px dashed var(--primary-color); border-radius: 8px; padding: 20px; margin-bottom: 20px;">
                <h3 style="color: var(--primary-color); margin: 0 0 20px 0;">üìö Schritt-f√ºr-Schritt Anleitung</h3>
                
                <!-- Schritt 1: Code kopieren -->
                <div style="background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid var(--primary-color);">
                    <p style="margin: 0 0 15px 0; font-weight: bold; font-size: 16px;">
                        1Ô∏è‚É£ Bookmarklet-Code kopieren
                    </p>
                    
                    <button class="primary-btn" id="copyBookmarkletBtn" style="font-size: 16px; margin-bottom: 10px;">
                        üìã Code in Zwischenablage kopieren
                    </button>
                    
                    <div id="copySuccess" style="display: none; background: #d4edda; border: 1px solid #c3e6cb; padding: 10px; border-radius: 4px; margin-top: 10px;">
                        <p style="margin: 0; color: #155724; font-weight: bold;">‚úÖ Code kopiert!</p>
                    </div>
                </div>
                
                <!-- Schritt 2: Lesezeichen erstellen -->
                <div style="background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid var(--secondary-color);">
                    <p style="margin: 0 0 15px 0; font-weight: bold; font-size: 16px;">
                        2Ô∏è‚É£ Lesezeichen erstellen
                    </p>
                    <ol style="margin: 0; padding-left: 20px; line-height: 1.8; font-size: 14px; color: #555;">
                        <li>Dr√ºcke <kbd style="background: #e0e0e0; padding: 2px 6px; border-radius: 3px; font-family: monospace;">Strg+D</kbd> (Windows) oder <kbd style="background: #e0e0e0; padding: 2px 6px; border-radius: 3px; font-family: monospace;">Cmd+D</kbd> (Mac)</li>
                        <li>Name: <code style="background: #e0e0e0; padding: 2px 8px; border-radius: 3px;">SwaF Events</code></li>
                        <li><strong>L√∂sche die URL komplett</strong> und f√ºge den kopierten Code ein (<kbd style="background: #e0e0e0; padding: 2px 6px; border-radius: 3px; font-family: monospace;">Strg+V</kbd>)</li>
                        <li>Speichere das Lesezeichen</li>
                    </ol>
                </div>
                
                <!-- Schritt 3: Events scrapen -->
                <div style="background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #ffc107;">
                    <p style="margin: 0 0 15px 0; font-weight: bold; font-size: 16px;">
                        3Ô∏è‚É£ Events scrapen
                    </p>
                    <ol style="margin: 0; padding-left: 20px; line-height: 1.8; font-size: 14px; color: #555;">
                        <li>√ñffne <a href="https://portal.startwithafriend.de/events" target="_blank" style="color: var(--primary-color); font-weight: bold;">portal.startwithafriend.de/events</a> in einem neuen Tab</li>
                        <li><strong>Warte, bis alle Events sichtbar sind</strong></li>
                        <li>Klicke auf dein <strong>"SwaF Events"</strong> Lesezeichen</li>
                        <li>Die Events werden automatisch kopiert</li>
                    </ol>
                </div>
                
                <!-- Schritt 4: Einf√ºgen -->
                <div style="background: white; padding: 20px; border-radius: 8px; border-left: 4px solid var(--accent-color);">
                    <p style="margin: 0 0 15px 0; font-weight: bold; font-size: 16px;">
                        4Ô∏è‚É£ Events hier einf√ºgen
                    </p>
                    <textarea id="pasteEventsArea" class="paste-events-textarea" placeholder='Nach dem Scraping: Strg+V / Cmd+V zum Einf√ºgen...'></textarea>
                    <button class="primary-btn" onclick="templateBuilder.importPastedEvents()" style="margin-top: 10px;">
                        ‚ú® Events importieren
                    </button>
                    <p style="font-size: 12px; color: #666; margin: 10px 0 0 0;">
                        üí° Tipp: Du kannst mehrere Seiten nacheinander scrapen und hier einf√ºgen!
                    </p>
                </div>
            </div>
            
            <div class="modal-actions">
                <button class="secondary-btn" id="cancelEventImport">Schlie√üen</button>
            </div>
        </div>
    </div>

    <script>
    document.getElementById('copyBookmarkletBtn').addEventListener('click', function() {
        // Verbesserter Scraper mit Datum-Extraktion, Sortierung und Debugging
        var code = "javascript:(function(){console.log('üéØ SwaF Scraper v7 - Verbessert');var e=[];var c=document.querySelectorAll('div.col-md-6,div.col-lg-4,div[class*=\"col\"]');console.log('Container gefunden:',c.length);for(var i=0;i<c.length;i++){var d=c[i];var l=d.querySelector('a[href*=\"event\"]');if(!l){console.log('Kein Event-Link in Container',i);continue;}var t=d.textContent||d.innerText||'';var lines=t.split('\\n').map(function(x){return x.trim();}).filter(function(x){return x.length>0;});console.log('Container',i,'Zeilen:',lines);if(lines.length<2)continue;var v={};var months=['Jan','Feb','M√§r','Apr','Mai','Jun','Jul','Aug','Sep','Okt','Nov','Dez'];var foundDate=false;for(var j=0;j<Math.min(5,lines.length);j++){var line=lines[j];console.log('Pr√ºfe Zeile',j,':',line);if(months.indexOf(line)>-1&&j<lines.length-1){var nextLine=lines[j+1];if(nextLine.match(/^\\d{1,2}$/)){v.month=line;v.day=nextLine;foundDate=true;console.log('Datum gefunden:',line,nextLine);break;}}var combined=line.split(/\\s+/);if(combined.length>=2&&months.indexOf(combined[0])>-1&&combined[1].match(/^\\d{1,2}$/)){v.month=combined[0];v.day=combined[1];foundDate=true;console.log('Datum in einer Zeile:',combined[0],combined[1]);break;}}if(foundDate){var y=new Date().getFullYear();var mi=months.indexOf(v.month);var dayNum=parseInt(v.day);var dt=new Date(y,mi,dayNum);if(dt<new Date()){dt.setFullYear(y+1);}v.date=dt.getFullYear()+'-'+(dt.getMonth()+1<10?'0':'')+(dt.getMonth()+1)+'-'+(dt.getDate()<10?'0':'')+dt.getDate();v.sortDate=dt.getTime();}else{v.month='TBD';v.day='?';v.date='';v.sortDate=999999999999999;console.log('Kein Datum gefunden');}var titleFound=false;for(var k=0;k<lines.length;k++){var w=lines[k];if(w.length>5&&w.indexOf('Anmeldung')===-1&&w.indexOf('m√∂glich')===-1&&w.indexOf('geschlossen')===-1&&months.indexOf(w)===-1&&!w.match(/^\\d{1,2}$/)&&!titleFound){v.title=w.replace(/ü§ù|‚ú®|üéâ|üíú|‚òï|Ô∏èüí¨|üé§/g,'').trim();titleFound=true;console.log('Titel:',v.title);break;}}if(!v.title||v.title.length<3){console.log('Kein Titel, √ºberspringe');continue;}var cities=['Berlin','Hamburg','M√ºnchen','K√∂ln','Frankfurt','Stuttgart','Dresden','Leipzig','Chemnitz','Freiburg','D√ºsseldorf','Mannheim','Hannover','Bundesweit'];v.location='';for(var ci=0;ci<cities.length;ci++){if(t.indexOf(cities[ci])>-1){v.location=cities[ci]==='Bundesweit'?'Online':cities[ci];break;}}var cats=['Infoabend','Workshop','Qualifizierung','Communityevent'];v.category='Community Event';for(var ca=0;ca<cats.length;ca++){if(t.indexOf(cats[ca])>-1){v.category=cats[ca]==='Communityevent'?'Community Event':cats[ca];break;}}v.eventMode=t.indexOf('Online')>-1?'Online':'Offline';var tm=t.match(/(\\d{1,2}):(\\d{2})/);v.time=tm?tm[0]+' Uhr':'';v.registrationLink=l.href;v.description='';v.highlight=false;e.push(v);console.log('‚úÖ Event hinzugef√ºgt:',v.title);}e.sort(function(a,b){return a.sortDate-b.sortDate;});var clean=[];for(var n=0;n<e.length;n++){var dup=false;for(var o=0;o<clean.length;o++){if(clean[o].title===e[n].title&&clean[o].date===e[n].date){dup=true;break;}}if(!dup){delete e[n].sortDate;clean.push(e[n]);}}console.log('‚úÖ '+clean.length+' Events sortiert');if(clean.length>0){var json=JSON.stringify(clean,null,2);navigator.clipboard.writeText(json).then(function(){alert('‚úÖ '+clean.length+' Events kopiert!\\n\\nChronologisch sortiert.\\nJetzt einf√ºgen (Strg+V).')}).catch(function(){prompt('Events:',json)})}else{alert('‚ö†Ô∏è Keine Events gefunden.\\nKonsole √∂ffnen (F12) f√ºr Details.')}})();";
        
        navigator.clipboard.writeText(code).then(function() {
            var btn = document.getElementById('copyBookmarkletBtn');
            var success = document.getElementById('copySuccess');
            
            btn.textContent = '‚úÖ Kopiert!';
            btn.style.backgroundColor = '#28a745';
            success.style.display = 'block';
            
            setTimeout(function() {
                btn.textContent = 'üìã Code in Zwischenablage kopieren';
                btn.style.backgroundColor = '';
            }, 3000);
        }).catch(function(err) {
            alert('Fehler beim Kopieren. Bitte F12 √∂ffnen und Screenshot senden.');
            console.error('Copy error:', err);
        });
    });
    </script>

    <script>
    function installBookmarklet() {
        // Der Scraper-Code - sauber und ohne Escape-Probleme
        const scraperCode = `javascript:(function(){
            console.log('üéØ SwaF Event Scraper v6');
            var events = [];
            
            // Suche Event-Container
            var cards = document.querySelectorAll('div.col-md-6.col-lg-4.mb-4, div.col-md-6, div.col-lg-4');
            console.log('Cards gefunden:', cards.length);
            
            for (var i = 0; i < cards.length; i++) {
                var card = cards[i];
                var link = card.querySelector('a');
                if (!link) continue;
                
                var text = link.textContent || '';
                var lines = text.split('\\n').map(function(l) { return l.trim(); }).filter(function(l) { return l.length > 0; });
                
                if (lines.length < 3) continue;
                
                var event = {};
                
                // Datum extrahieren
                var months = ['Jan','Feb','M√§r','Apr','Mai','Jun','Jul','Aug','Sep','Okt','Nov','Dez'];
                for (var j = 0; j < Math.min(3, lines.length); j++) {
                    var parts = lines[j].split(' ');
                    if (parts.length === 2 && months.indexOf(parts[0]) > -1) {
                        event.month = parts[0];
                        event.day = parts[1];
                        
                        var monthIdx = months.indexOf(parts[0]);
                        var year = new Date().getFullYear();
                        var d = new Date(year, monthIdx, parseInt(parts[1]));
                        if (d < new Date()) d.setFullYear(year + 1);
                        
                        var m = d.getMonth() + 1;
                        var day = d.getDate();
                        event.date = d.getFullYear() + '-' + (m < 10 ? '0' : '') + m + '-' + (day < 10 ? '0' : '') + day;
                        break;
                    }
                }
                
                if (!event.date) {
                    event.month = 'TBD';
                    event.day = '?';
                    event.date = '';
                }
                
                // Titel finden
                for (var k = 0; k < lines.length; k++) {
                    var line = lines[k];
                    if (line.length > 5 && 
                        line.indexOf('Anmeldung') === -1 && 
                        line.indexOf('m√∂glich') === -1 && 
                        !line.match(/^(Jan|Feb|M√§r|Apr|Mai|Jun|Jul|Aug|Sep|Okt|Nov|Dez)/) &&
                        !event.title) {
                        event.title = line.replace(/ü§ù|‚ú®|üéâ/g, '').trim();
                        break;
                    }
                }
                
                if (!event.title) continue;
                
                // Ort
                var locs = ['Berlin','Hamburg','M√ºnchen','K√∂ln','Frankfurt','Stuttgart','Dresden','Leipzig','Chemnitz','Freiburg','D√ºsseldorf','Mannheim','Hannover','Bundesweit'];
                event.location = '';
                for (var l = 0; l < locs.length; l++) {
                    if (text.indexOf(locs[l]) > -1) {
                        event.location = locs[l] === 'Bundesweit' ? 'Online' : locs[l];
                        break;
                    }
                }
                
                // Kategorie
                if (text.indexOf('Infoabend') > -1) event.category = 'Infoabend';
                else if (text.indexOf('Workshop') > -1 || text.indexOf('Qualifizierung') > -1) event.category = 'Workshop';
                else event.category = 'Community Event';
                
                // Modus
                event.eventMode = text.indexOf('Online') > -1 ? 'Online' : 'Offline';
                
                // Zeit
                var timeMatch = text.match(/(\\d{1,2}):(\\d{2})/);
                event.time = timeMatch ? timeMatch[0] + ' Uhr' : '';
                
                // Link & Beschreibung
                event.registrationLink = link.href;
                event.description = '';
                
                events.push(event);
            }
            
            // Duplikate entfernen
            var clean = [];
            for (var n = 0; n < events.length; n++) {
                var isDup = false;
                for (var o = 0; o < clean.length; o++) {
                    if (clean[o].title === events[n].title && clean[o].date === events[n].date) {
                        isDup = true;
                        break;
                    }
                }
                if (!isDup && events[n].title && events[n].title.length > 3) {
                    clean.push(events[n]);
                }
            }
            
            console.log('Events extrahiert:', clean.length);
            
            if (clean.length > 0) {
                var json = JSON.stringify(clean, null, 2);
                navigator.clipboard.writeText(json).then(function() {
                    alert('‚úÖ ' + clean.length + ' Events kopiert!\\n\\nJetzt im Newsletter Builder einf√ºgen.');
                }).catch(function() {
                    prompt('Events kopieren:', json);
                });
            } else {
                alert('‚ö†Ô∏è Keine Events gefunden.\\nF12 dr√ºcken f√ºr Details.');
            }
        })();`;
        
        // Code in Zwischenablage kopieren
        navigator.clipboard.writeText(scraperCode).then(function() {
            document.getElementById('installInstructions').style.display = 'block';
        }).catch(function(err) {
            prompt('Bitte kopiere diesen Code manuell:', scraperCode);
        });
    }
    </script>

    <!-- Copy HTML Modal -->
    <div id="copyHTMLModal" class="modal">
        <div class="modal-content" style="min-width: 700px;">
            <div class="modal-header">
                <h2>HTML f√ºr CleverReach</h2>
            </div>
            <div class="copy-html-box">
                <p>Der HTML-Code wurde in die Zwischenablage kopiert! F√ºgen Sie ihn direkt in CleverReach ein.</p>
                <div class="html-preview" id="htmlPreview"></div>
                <button class="primary-btn" onclick="templateBuilder.copyHTMLAgain()">Erneut kopieren</button>
            </div>
            <div class="modal-actions">
                <button class="primary-btn" id="closeCopyHTML">Schlie√üen</button>
            </div>
        </div>
    </div>

    <!-- Preview Modal -->
    <div id="previewModal" class="modal">
        <div class="modal-content" style="width: 90vw; max-width: 1200px;">
            <div class="modal-header">
                <h2>Template Vorschau</h2>
            </div>
            <div style="height: 600px; overflow-y: auto; border: 1px solid #ddd; border-radius: 4px; background: white;">
                <iframe id="previewFrame" style="width: 100%; height: 100%; border: none;"></iframe>
            </div>
            <div class="modal-actions">
                <button class="primary-btn" id="closePreview">Schlie√üen</button>
            </div>
        </div>
    </div>

    <div id="overlay"></div>

    <script>
        // Module Templates Definition
        const MODULE_TEMPLATES = {
            'preheader': {
                title: 'Preheader',
                html: `<div id="CR-PRHEADER" style="display:none;font-size:1px;line-height:1px;max-height:0px;max-width:0px;opacity:0;overflow:hidden;mso-hide:all;">{{preheaderText}}&zwnj;&nbsp;&zwnj;&nbsp;&zwnj;&nbsp;&zwnj;&nbsp;&zwnj;&nbsp;</div>`,
                fields: [
                    { name: 'preheaderText', label: 'Preheader Text (max. 100 Zeichen)', type: 'text', default: 'Wir freuen uns dich zu sehen.' }
                ]
            },
            'header': {
                title: 'Header (Logo & Onlineversion)',
                html: `
                    <table align="center" border="0" cellpadding="0" cellspacing="0" style="width:640px">
                        <tbody>
                            <tr>
                                <td style="padding: 20px 30px;">
                                    <table align="left" style="width: 280px;">
                                        <tbody>
                                            <tr>
                                                <td align="left" style="padding-top:20px;padding-bottom:0px;">
                                                    <a href="{{logoLink}}">
                                                        <img alt="Start with a Friend" height="36" src="{{logoUrl}}" style="border: 0px; display: block; width: 180px; height: 36px;" width="180">
                                                    </a>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                `,
                fields: [
                    { name: 'logoUrl', label: 'Logo URL', type: 'text', default: 'https://www.start-with-a-friend.de/wp-content/uploads/2023/05/start-with-a-friend-mobile-logo-1-ai-1.svg' },
                    { name: 'logoLink', label: 'Logo Link', type: 'text', default: 'https://www.start-with-a-friend.de/' },
                ]
            },
            'hero-image': {
                title: 'Hero Bild',
                html: `
                    <table align="center" border="0" cellpadding="0" cellspacing="0" style="width:640px">
                        <tbody>
                            <tr>
                                <td style="padding: 0;">
                                    <img src="{{heroImageUrl}}" alt="{{heroImageAlt}}" style="width: 100%; max-width: 640px; height: auto; display: block;">
                                </td>
                            </tr>
                        </tbody>
                    </table>
                `,
                fields: [
                    { name: 'heroImageUrl', label: 'Hero Bild URL', type: 'image', default: 'https://via.placeholder.com/640x360' },
                    { name: 'heroImageAlt', label: 'Bild Alt-Text', type: 'text', default: 'Hero Image' }
                ]
            },
            'greeting': {
                title: 'Begr√º√üung',
                html: `
                    <table align="center" border="0" cellpadding="0" cellspacing="0" style="width:640px">
                        <tbody>
                            <tr>
                                <td style="padding: 30px;">
                                    <h2 style="color: #009a93; margin: 0 0 15px 0;">{{greetingTitle}}</h2>
                                    <p style="color: #333; line-height: 1.6; margin: 0;">{{greetingText}}</p>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                `,
                fields: [
                    { name: 'greetingTitle', label: 'Begr√º√üung', type: 'text', default: 'Hallo {FIRSTNAME[std:liebe/r Freund/in]}!' },
                    { name: 'greetingText', label: 'Begr√º√üungstext', type: 'textarea', default: 'sch√∂n, dass du dabei bist! Wir haben wieder spannende Neuigkeiten und Events f√ºr dich.' }
                ]
            },
            'text-only': {
                title: 'Nur Text',
                html: `
                    <table align="center" border="0" cellpadding="0" cellspacing="0" style="width:640px">
                        <tbody>
                            <tr>
                                <td style="padding: 20px 30px;">
                                    <h3 style="color: #009a93; margin: 0 0 15px 0;">{{textTitle}}</h3>
                                    <p style="color: #333; line-height: 1.6;">{{textContent}}</p>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                `,
                fields: [
                    { name: 'textTitle', label: '√úberschrift (optional)', type: 'text', default: '' },
                    { name: 'textContent', label: 'Text', type: 'textarea', default: 'Ihr Text hier...' }
                ]
            },
            'image-text': {
                title: 'Bild & Text',
                html: `
                    <table align="center" border="0" cellpadding="0" cellspacing="0" style="width:640px">
                        <tbody>
                            <tr>
                                <td style="padding: 20px 30px;">
                                    <img src="{{imageUrl}}" alt="{{imageAlt}}" style="width: 100%; max-width: 580px; height: auto;">
                                    <h2 style="color: #009a93; margin: 20px 0 10px 0;">{{headline}}</h2>
                                    <p style="color: #333; line-height: 1.6;">{{text}}</p>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                `,
                fields: [
                    { name: 'imageUrl', label: 'Bild URL', type: 'image', default: 'https://via.placeholder.com/580x290' },
                    { name: 'imageAlt', label: 'Bild Alt-Text', type: 'text', default: 'Bild' },
                    { name: 'headline', label: '√úberschrift', type: 'text', default: '√úberschrift' },
                    { name: 'text', label: 'Text', type: 'textarea', default: 'Hier kommt Ihr Text.' }
                ]
            },
            'events': {
                title: 'Events',
                html: `<div class="events-container">{{eventsContent}}</div>`,
                fields: [
                    { name: 'eventsTitle', label: 'Events √úberschrift', type: 'text', default: 'Unsere n√§chsten Events' },
                    { name: 'events', label: 'Events', type: 'dynamic-list', default: [] }
                ]
            },
            'two-columns': {
                title: 'Zwei Spalten',
                html: `
                    <table align="center" border="0" cellpadding="0" cellspacing="0" style="width:640px">
                        <tbody>
                            <tr>
                                <td style="padding: 20px 30px;">
                                    <table width="100%" border="0" cellspacing="0" cellpadding="0">
                                        <tr>
                                            <td width="48%" valign="top">
                                                <h3 style="color: #009a93; margin: 0 0 10px 0;">{{leftTitle}}</h3>
                                                <p style="margin: 0 0 15px 0; line-height: 1.6;">{{leftContent}}</p>
                                                <a href="{{leftButtonLink}}" style="display: inline-block; background: #009a93; color: white; padding: 10px 20px; border-radius: 6px; font-weight: bold; text-decoration: none; font-size: 14px;">{{leftButtonText}}</a>
                                            </td>
                                            <td width="4%"></td>
                                            <td width="48%" valign="top">
                                                <h3 style="color: #009a93; margin: 0 0 10px 0;">{{rightTitle}}</h3>
                                                <p style="margin: 0 0 15px 0; line-height: 1.6;">{{rightContent}}</p>
                                                <a href="{{rightButtonLink}}" style="display: inline-block; background: #009a93; color: white; padding: 10px 20px; border-radius: 6px; font-weight: bold; text-decoration: none; font-size: 14px;">{{rightButtonText}}</a>
                                            </td>
                                        </tr>
                                    </table>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                `,
                fields: [
                    { name: 'leftTitle', label: 'Linke √úberschrift', type: 'text', default: '√úberschrift Links' },
                    { name: 'leftContent', label: 'Linker Inhalt', type: 'textarea', default: 'Inhalt der linken Spalte' },
                    { name: 'leftButtonText', label: 'Linker Button Text', type: 'text', default: 'Mehr erfahren' },
                    { name: 'leftButtonLink', label: 'Linker Button Link', type: 'text', default: 'https://www.start-with-a-friend.de/' },
                    { name: 'rightTitle', label: 'Rechte √úberschrift', type: 'text', default: '√úberschrift Rechts' },
                    { name: 'rightContent', label: 'Rechter Inhalt', type: 'textarea', default: 'Inhalt der rechten Spalte' },
                    { name: 'rightButtonText', label: 'Rechter Button Text', type: 'text', default: 'Mehr erfahren' },
                    { name: 'rightButtonLink', label: 'Rechter Button Link', type: 'text', default: 'https://www.start-with-a-friend.de/' }
                ]
            },
            'three-columns': {
                title: 'Drei Spalten',
                html: `
                    <table align="center" border="0" cellpadding="0" cellspacing="0" style="width:640px">
                        <tbody>
                            <tr>
                                <td style="padding: 20px 30px;">
                                    <table width="100%" border="0" cellspacing="0" cellpadding="0">
                                        <tr>
                                            <td width="31%" valign="top">
                                                <h4 style="color: #009a93; margin: 0 0 10px 0; font-size: 16px;">{{col1Title}}</h4>
                                                <p style="font-size: 14px; margin: 0 0 12px 0; line-height: 1.5;">{{col1Content}}</p>
                                                <a href="{{col1ButtonLink}}" style="display: inline-block; background: #009a93; color: white; padding: 8px 16px; border-radius: 6px; font-weight: bold; text-decoration: none; font-size: 13px;">{{col1ButtonText}}</a>
                                            </td>
                                            <td width="3.5%"></td>
                                            <td width="31%" valign="top">
                                                <h4 style="color: #009a93; margin: 0 0 10px 0; font-size: 16px;">{{col2Title}}</h4>
                                                <p style="font-size: 14px; margin: 0 0 12px 0; line-height: 1.5;">{{col2Content}}</p>
                                                <a href="{{col2ButtonLink}}" style="display: inline-block; background: #009a93; color: white; padding: 8px 16px; border-radius: 6px; font-weight: bold; text-decoration: none; font-size: 13px;">{{col2ButtonText}}</a>
                                            </td>
                                            <td width="3.5%"></td>
                                            <td width="31%" valign="top">
                                                <h4 style="color: #009a93; margin: 0 0 10px 0; font-size: 16px;">{{col3Title}}</h4>
                                                <p style="font-size: 14px; margin: 0 0 12px 0; line-height: 1.5;">{{col3Content}}</p>
                                                <a href="{{col3ButtonLink}}" style="display: inline-block; background: #009a93; color: white; padding: 8px 16px; border-radius: 6px; font-weight: bold; text-decoration: none; font-size: 13px;">{{col3ButtonText}}</a>
                                            </td>
                                        </tr>
                                    </table>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                `,
                fields: [
                    { name: 'col1Title', label: 'Spalte 1 Titel', type: 'text', default: 'Titel 1' },
                    { name: 'col1Content', label: 'Spalte 1 Inhalt', type: 'textarea', default: 'Inhalt 1' },
                    { name: 'col1ButtonText', label: 'Spalte 1 Button', type: 'text', default: 'Mehr' },
                    { name: 'col1ButtonLink', label: 'Spalte 1 Link', type: 'text', default: 'https://www.start-with-a-friend.de/' },
                    { name: 'col2Title', label: 'Spalte 2 Titel', type: 'text', default: 'Titel 2' },
                    { name: 'col2Content', label: 'Spalte 2 Inhalt', type: 'textarea', default: 'Inhalt 2' },
                    { name: 'col2ButtonText', label: 'Spalte 2 Button', type: 'text', default: 'Mehr' },
                    { name: 'col2ButtonLink', label: 'Spalte 2 Link', type: 'text', default: 'https://www.start-with-a-friend.de/' },
                    { name: 'col3Title', label: 'Spalte 3 Titel', type: 'text', default: 'Titel 3' },
                    { name: 'col3Content', label: 'Spalte 3 Inhalt', type: 'textarea', default: 'Inhalt 3' },
                    { name: 'col3ButtonText', label: 'Spalte 3 Button', type: 'text', default: 'Mehr' },
                    { name: 'col3ButtonLink', label: 'Spalte 3 Link', type: 'text', default: 'https://www.start-with-a-friend.de/' }
                ]
            },
            'quote': {
                title: 'Zitat',
                html: `
                    <table align="center" border="0" cellpadding="0" cellspacing="0" style="width:640px">
                        <tbody>
                            <tr>
                                <td style="padding: 30px; background-color: #f8f9fa; border-left: 4px solid #009a93;">
                                    <blockquote style="margin: 0; font-style: italic; color: #555; font-size: 18px; line-height: 1.6;">
                                        "{{quoteText}}"
                                    </blockquote>
                                    <p style="margin-top: 15px; color: #009a93; font-weight: bold;">‚Äî {{quoteAuthor}}</p>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                `,
                fields: [
                    { name: 'quoteText', label: 'Zitat', type: 'textarea', default: 'Integration ist keine Einbahnstra√üe, sondern ein gemeinsamer Weg.' },
                    { name: 'quoteAuthor', label: 'Autor', type: 'text', default: 'Start with a Friend' }
                ]
            },
            'button-center': {
                title: 'Button (zentriert)',
                html: `
                    <table align="center" border="0" cellpadding="0" cellspacing="0" style="width:640px">
                        <tbody>
                            <tr>
                                <td style="padding: 30px; text-align: center;">
                                    <a href="{{buttonLink}}" style="display: inline-block; padding: 14px 32px; background-color: #009a93; color: white; text-decoration: none; border-radius: 6px; font-weight: bold; font-size: 16px;">{{buttonText}}</a>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                `,
                fields: [
                    { name: 'buttonText', label: 'Button Text', type: 'text', default: 'Jetzt mitmachen' },
                    { name: 'buttonLink', label: 'Button Link', type: 'text', default: 'https://www.start-with-a-friend.de/mitmachen/' }
                ]
            },
            'three-buttons': {
                title: 'Drei Buttons',
                html: `
                    <table align="center" border="0" cellpadding="0" cellspacing="0" style="width:640px">
                        <tbody>
                            <tr>
                                <td style="padding: 20px 30px;">
                                    <table width="100%" border="0" cellspacing="0" cellpadding="0">
                                        <tr>
                                            <td width="31%" align="center" valign="top">
                                                <a href="{{button1Link}}" style="display: inline-block; background: #009a93; color: white; padding: 12px 20px; border-radius: 6px; font-weight: bold; text-decoration: none; font-size: 14px; width: 100%; text-align: center; box-sizing: border-box;">{{button1Text}}</a>
                                            </td>
                                            <td width="3.5%"></td>
                                            <td width="31%" align="center" valign="top">
                                                <a href="{{button2Link}}" style="display: inline-block; background: #009a93; color: white; padding: 12px 20px; border-radius: 6px; font-weight: bold; text-decoration: none; font-size: 14px; width: 100%; text-align: center; box-sizing: border-box;">{{button2Text}}</a>
                                            </td>
                                            <td width="3.5%"></td>
                                            <td width="31%" align="center" valign="top">
                                                <a href="{{button3Link}}" style="display: inline-block; background: #009a93; color: white; padding: 12px 20px; border-radius: 6px; font-weight: bold; text-decoration: none; font-size: 14px; width: 100%; text-align: center; box-sizing: border-box;">{{button3Text}}</a>
                                            </td>
                                        </tr>
                                    </table>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                `,
                fields: [
                    { name: 'button1Text', label: 'Button 1 Text', type: 'text', default: 'Button 1' },
                    { name: 'button1Link', label: 'Button 1 Link', type: 'text', default: 'https://www.start-with-a-friend.de/' },
                    { name: 'button2Text', label: 'Button 2 Text', type: 'text', default: 'Button 2' },
                    { name: 'button2Link', label: 'Button 2 Link', type: 'text', default: 'https://www.start-with-a-friend.de/' },
                    { name: 'button3Text', label: 'Button 3 Text', type: 'text', default: 'Button 3' },
                    { name: 'button3Link', label: 'Button 3 Link', type: 'text', default: 'https://www.start-with-a-friend.de/' }
                ]
            },

            'cta-section': {
                title: 'Call-to-Action',
                html: `
                    <table align="center" border="0" cellpadding="0" cellspacing="0" style="width:640px">
                        <tbody>
                            <tr>
                                <td style="padding: 30px; background-color: #f8f9fa; text-align: center;">
                                    <h2 style="color: #009a93; margin-bottom: 15px;">{{ctaTitle}}</h2>
                                    <p style="margin-bottom: 20px;">{{ctaText}}</p>
                                    <a href="{{ctaLink}}" style="display: inline-block; padding: 12px 30px; background-color: #009a93; color: white; text-decoration: none; border-radius: 6px; font-weight: bold;">{{ctaButtonText}}</a>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                `,
                fields: [
                    { name: 'ctaTitle', label: '√úberschrift', type: 'text', default: 'Werde aktiv!' },
                    { name: 'ctaText', label: 'Text', type: 'textarea', default: 'Melde dich jetzt an und werde Teil unserer Community.' },
                    { name: 'ctaButtonText', label: 'Button Text', type: 'text', default: 'Jetzt mitmachen' },
                    { name: 'ctaLink', label: 'Button Link', type: 'text', default: 'https://www.start-with-a-friend.de/mitmachen/' }
                ]
            },
            'social-media': {
                title: 'Social Media',
                html: `
                    <table align="center" border="0" cellpadding="0" cellspacing="0" style="width:640px">
                        <tbody>
                            <tr>
                                <td style="padding: 30px; text-align: center; background-color: #f8f9fa;">
                                    <h3 style="color: #009a93; margin-bottom: 20px;">{{socialTitle}}</h3>
                                    <table align="center" style="display: inline-table;">
                                        <tr>
                                            <td style="padding: 0 10px;">
                                                <a href="{{facebookLink}}">
                                                    <img src="https://cdn-icons-png.flaticon.com/512/124/124010.png" alt="Facebook" width="32" height="32">
                                                </a>
                                            </td>
                                            <td style="padding: 0 10px;">
                                                <a href="{{instagramLink}}">
                                                    <img src="https://cdn-icons-png.flaticon.com/512/2111/2111463.png" alt="Instagram" width="32" height="32">
                                                </a>
                                            </td>
                                            <td style="padding: 0 10px;">
                                                <a href="{{linkedinLink}}">
                                                    <img src="https://cdn-icons-png.flaticon.com/512/174/174857.png" alt="LinkedIn" width="32" height="32">
                                                </a>
                                            </td>
                                        </tr>
                                    </table>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                `,
                fields: [
                    { name: 'socialTitle', label: '√úberschrift', type: 'text', default: 'Folge uns auf Social Media' },
                    { name: 'facebookLink', label: 'Facebook Link', type: 'text', default: 'https://www.facebook.com/startwithafriend' },
                    { name: 'instagramLink', label: 'Instagram Link', type: 'text', default: 'https://www.instagram.com/teamswaf' },
                    { name: 'linkedinLink', label: 'LinkedIn Link', type: 'text', default: 'https://www.linkedin.com/company/start-with-a-friend' }
                ]
            },
            'divider': {
                title: 'Trennlinie',
                html: `
                    <table align="center" border="0" cellpadding="0" cellspacing="0" style="width:640px">
                        <tbody>
                            <tr>
                                <td style="padding: 20px 30px;">
                                    <hr style="border: none; border-top: {{dividerStyle}} {{dividerWidth}}px {{dividerColor}}; margin: 0;">
                                </td>
                            </tr>
                        </tbody>
                    </table>
                `,
                fields: [
                    { name: 'dividerStyle', label: 'Stil', type: 'select', options: ['solid', 'dashed', 'dotted'], default: 'solid' },
                    { name: 'dividerWidth', label: 'Breite (px)', type: 'number', default: '1' },
                    { name: 'dividerColor', label: 'Farbe', type: 'text', default: '#e0e0e0' }
                ]
            },
            'contact-person': {
                title: 'Ansprechpartner',
                html: `
                    <table align="center" border="0" cellpadding="0" cellspacing="0" style="width:640px">
                        <tbody>
                            <tr>
                                <td style="padding: 20px 30px;">
                                    <h3 style="color: #009a93;">{{contactTitle}}</h3>
                                    <table>
                                        <tr>
                                            <td style="width: 120px; vertical-align: top;">
                                                <img src="{{contactImageUrl}}" alt="{{contactImageAlt}}" style="width: 100px; height: 100px; border-radius: 50%;">
                                            </td>
                                            <td style="padding-left: 20px; vertical-align: top;">
                                                <p style="font-weight: bold; margin: 0;">{{contactName}}</p>
                                                <p style="margin: 5px 0;">{{contactPosition}}</p>
                                                <p style="margin: 5px 0;">{{contactEmail}}</p>
                                                <p style="margin: 5px 0;">{{contactPhone}}</p>
                                            </td>
                                        </tr>
                                    </table>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                `,
                fields: [
                    { name: 'contactTitle', label: '√úberschrift', type: 'text', default: 'Dein Ansprechpartner' },
                    { name: 'contactImageUrl', label: 'Bild URL', type: 'image', default: 'https://via.placeholder.com/120x120' },
                    { name: 'contactImageAlt', label: 'Bild Alt-Text', type: 'text', default: 'Profilbild' },
                    { name: 'contactName', label: 'Name', type: 'text', default: 'Max Mustermann' },
                    { name: 'contactPosition', label: 'Position', type: 'text', default: 'Standortleitung Berlin' },
                    { name: 'contactEmail', label: 'E-Mail', type: 'text', default: 'berlin@start-with-a-friend.de' },
                    { name: 'contactPhone', label: 'Telefon', type: 'text', default: '+49 30 5557 7855' }
                ]
            },
            'partner-news': {
                title: 'Partner News',
                html: `
                    <table align="center" border="0" cellpadding="0" cellspacing="0" style="width:640px">
                        <tbody>
                            <tr>
                                <td style="padding: 20px 30px; background-color: #f8f9fa;">
                                    <h3 style="color: #009a93;">{{partnerTitle}}</h3>
                                    <img src="{{partnerLogo}}" alt="{{partnerAlt}}" style="max-width: 200px; margin: 15px 0;">
                                    <p>{{partnerContent}}</p>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                `,
                fields: [
                    { name: 'partnerTitle', label: 'Titel', type: 'text', default: 'News von unseren Partnern' },
                    { name: 'partnerLogo', label: 'Partner Logo URL', type: 'image', default: 'https://via.placeholder.com/200x80' },
                    { name: 'partnerAlt', label: 'Logo Alt-Text', type: 'text', default: 'Partner Logo' },
                    { name: 'partnerContent', label: 'Inhalt', type: 'textarea', default: 'Informationen √ºber unsere Partner.' }
                ]
            },
            'footer-imprint': {
                title: 'Footer/Impressum',
                html: `
                    <table align="center" border="0" cellpadding="0" cellspacing="0" style="width:640px">
                        <tbody>
                            <tr>
                                <td style="padding: 20px 30px; text-align: center; font-size: 12px; color: #666;">
                                    <p>Start with a Friend e.V.</p>
                                    <p>Wiclefstra√üe 17, 10551 Berlin</p>
                                    <p>Tel: +49 30 5557 7855</p>
                                    <p>E-Mail: info@start-with-a-friend.de</p>
                                    <p style="margin-top: 10px;">
                                        <a href="https://www.start-with-a-friend.de" style="color: #009a93;">Website</a> |
                                        <a href="https://www.facebook.com/startwithafriend" style="color: #009a93;">Facebook</a> |
                                        <a href="https://www.instagram.com/teamswaf" style="color: #009a93;">Instagram</a>
                                    </p>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                `,
                fields: []
            },
        };

        // Template Builder Class
        class TemplateBuilder {
            constructor() {
                this.modules = [];
                this.moduleCounter = 0;
                this.currentEditingModule = null;
                this.currentHTML = '';
                this.init();
            }

            init() {
                this.setupEventListeners();
                this.setupDragAndDrop();
                this.loadAutoSave();
            }

            setupEventListeners() {
                // Header buttons
                document.getElementById('newTemplateBtn').addEventListener('click', () => this.newTemplate());
                document.getElementById('saveTemplateBtn').addEventListener('click', () => this.saveTemplate());
                document.getElementById('loadTemplateBtn').addEventListener('click', () => this.loadTemplate());
                document.getElementById('exportTemplateBtn').addEventListener('click', () => this.exportJSON());
                document.getElementById('importTemplateBtn').addEventListener('click', () => this.importJSON());
                document.getElementById('previewBtn').addEventListener('click', () => this.showPreview());
                document.getElementById('copyHTMLBtn').addEventListener('click', () => this.copyHTML());
                
                // Editor actions
                document.getElementById('clearTemplateBtn').addEventListener('click', () => this.clearTemplate());
                document.getElementById('generateHTMLBtn').addEventListener('click', () => this.generateHTML());
                
                // Modal actions
                document.getElementById('cancelModuleEdit').addEventListener('click', () => this.closeModuleEditor());
                document.getElementById('saveModuleEdit').addEventListener('click', () => this.saveModuleEdit());
                document.getElementById('closePreview').addEventListener('click', () => this.closePreview());
                document.getElementById('cancelEventImport').addEventListener('click', () => this.closeEventImport());
                document.getElementById('closeCopyHTML').addEventListener('click', () => this.closeCopyHTML());
                
                // Module editor tabs
                document.querySelectorAll('.module-editor-tab').forEach(tab => {
                    tab.addEventListener('click', (e) => this.switchTab(e.target.dataset.tab));
                });
                
                // Overlay
                document.getElementById('overlay').addEventListener('click', () => {
                    this.closeModuleEditor();
                    this.closePreview();
                    this.closeEventImport();
                    this.closeCopyHTML();
                });
                
                // Auto-save on changes
                document.getElementById('templateTitle').addEventListener('input', () => this.autoSave());
            }

            setupDragAndDrop() {
                const sidebar = document.querySelector('.sidebar');
                const previewArea = document.querySelector('.preview-content');
                
                // Sidebar modules
                sidebar.querySelectorAll('.module').forEach(module => {
                    module.addEventListener('dragstart', (e) => {
                        e.dataTransfer.effectAllowed = 'copy';
                        e.dataTransfer.setData('moduleType', module.dataset.moduleType);
                        e.dataTransfer.setData('action', 'add');
                    });
                });
                
                // Preview area
                previewArea.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    e.dataTransfer.dropEffect = 'copy';
                    previewArea.classList.add('drag-over');
                });
                
                previewArea.addEventListener('dragleave', () => {
                    previewArea.classList.remove('drag-over');
                });
                
                previewArea.addEventListener('drop', (e) => {
                    e.preventDefault();
                    previewArea.classList.remove('drag-over');
                    
                    const action = e.dataTransfer.getData('action');
                    
                    if (action === 'add') {
                        const moduleType = e.dataTransfer.getData('moduleType');
                        this.addModule(moduleType);
                    }
                });
            }

            addModule(type) {
                const template = MODULE_TEMPLATES[type];
                if (!template) return;
                
                const moduleId = `module-${++this.moduleCounter}`;
                const moduleData = {
                    id: moduleId,
                    type: type,
                    fields: {}
                };
                
                // Set default values
                template.fields.forEach(field => {
                    moduleData.fields[field.name] = field.default;
                });
                
                this.modules.push(moduleData);
                this.renderModule(moduleData);
                this.autoSave();
                this.showNotification('Modul hinzugef√ºgt');
            }

            renderModule(moduleData) {
                const previewContent = document.getElementById('previewContent');
                
                // Clear placeholder if this is the first module
                if (this.modules.length === 1) {
                    previewContent.innerHTML = '';
                }
                
                const moduleElement = document.createElement('div');
                moduleElement.className = 'template-module';
                moduleElement.id = moduleData.id;
                moduleElement.draggable = true;
                
                const template = MODULE_TEMPLATES[moduleData.type];
                
                moduleElement.innerHTML = `
                    <div class="module-header">
                        <div class="module-header-left">
                            <span class="module-drag-handle"></span>
                            <span class="module-title">${template.title}</span>
                        </div>
                        <div class="module-actions">
                            <button class="move-up" onclick="templateBuilder.moveModuleUp('${moduleData.id}')" title="Nach oben">‚Üë</button>
                            <button class="move-down" onclick="templateBuilder.moveModuleDown('${moduleData.id}')" title="Nach unten">‚Üì</button>
                            <button class="edit-module" onclick="templateBuilder.editModule('${moduleData.id}')">‚úé Bearbeiten</button>
                            <button class="duplicate-module" onclick="templateBuilder.duplicateModule('${moduleData.id}')">‚éò Duplizieren</button>
                            <button class="delete-module" onclick="templateBuilder.deleteModule('${moduleData.id}')">‚úï L√∂schen</button>
                        </div>
                    </div>
                    <div class="module-content">
                        ${this.renderModuleContent(moduleData)}
                    </div>
                `;
                
                previewContent.appendChild(moduleElement);
                this.setupModuleDragAndDrop(moduleElement);
            }

            moveModuleUp(moduleId) {
                const index = this.modules.findIndex(m => m.id === moduleId);
                if (index > 0) {
                    // Swap in array
                    [this.modules[index], this.modules[index - 1]] = [this.modules[index - 1], this.modules[index]];
                    
                    // Swap in DOM
                    const element = document.getElementById(moduleId);
                    const prevElement = element.previousElementSibling;
                    if (prevElement) {
                        element.parentNode.insertBefore(element, prevElement);
                    }
                    
                    this.autoSave();
                }
            }

            moveModuleDown(moduleId) {
                const index = this.modules.findIndex(m => m.id === moduleId);
                if (index < this.modules.length - 1) {
                    // Swap in array
                    [this.modules[index], this.modules[index + 1]] = [this.modules[index + 1], this.modules[index]];
                    
                    // Swap in DOM
                    const element = document.getElementById(moduleId);
                    const nextElement = element.nextElementSibling;
                    if (nextElement) {
                        element.parentNode.insertBefore(nextElement, element);
                    }
                    
                    this.autoSave();
                }
            }

            renderModuleContent(moduleData) {
                const template = MODULE_TEMPLATES[moduleData.type];
                let html = template.html;
                
                // Special handling for events module
                if (moduleData.type === 'events') {
                    const events = moduleData.fields.events || [];
                    const validEvents = events.filter(event => event.title && event.title.trim() !== '' && event.title !== 'Event');
                    
                    let eventsHtml = `
                        <table align="center" border="0" cellpadding="0" cellspacing="0" style="width:640px">
                            <tbody>
                                <tr>
                                    <td style="padding: 20px 30px; text-align: center;">
                                        <h2 style="color: #009a93; margin: 0 0 20px 0; font-size: 24px; font-weight: bold;">
                                            ${moduleData.fields.eventsTitle || 'Unsere n√§chsten Events'}
                                        </h2>
                                        ${validEvents.length > 0 ? 
                                            `<p style="color: #666; margin: 0 0 30px 0; font-size: 16px;">
                                                Entdecke ${validEvents.length} spannende Event${validEvents.length !== 1 ? 's' : ''} in deiner N√§he:
                                            </p>` : ''
                                        }
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    `;
                    
                    if (validEvents.length === 0) {
                        eventsHtml += `
                            <table align="center" border="0" cellpadding="0" cellspacing="0" style="width:640px">
                                <tbody>
                                    <tr>
                                        <td style="padding: 20px 30px; text-align: center;">
                                            <div style="background: #f8f9fa; border: 2px dashed #ddd; border-radius: 8px; padding: 40px; margin: 20px 0;">
                                                <p style="color: #666; margin: 0; font-size: 16px;">
                                                    üìÖ Keine Events vorhanden.<br>
                                                    Klicken Sie auf "Bearbeiten" um Events hinzuzuf√ºgen.
                                                </p>
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        `;
                    } else {
                        validEvents.forEach((event, index) => {
                            eventsHtml += this.renderEventHTML(event, index);
                        });
                    }
                    
                    html = html.replace('{{eventsContent}}', eventsHtml);
} else {
                    // Replace placeholders with field values
                    template.fields.forEach(field => {
                        const value = moduleData.fields[field.name] || field.default;
                        const regex = new RegExp(`{{${field.name}}}`, 'g');
                        html = html.replace(regex, value);
                    });
                }
                
                return html;
            }

            renderEventHTML(event, index) {
                const eventNumber = index + 1;
                const isHighlighted = event.highlight || false;
                const highlightStyle = isHighlighted ? 'background: linear-gradient(135deg, #fff9e6 0%, #ffffff 100%); border: 2px solid #ffc107;' : '';
                const highlightBadge = isHighlighted ? '<div style="position: absolute; top: 10px; right: 10px; background: #ffc107; color: #000; padding: 4px 12px; border-radius: 12px; font-size: 11px; font-weight: bold;">‚≠ê HIGHLIGHT</div>' : '';
                
                return `
                    <table align="center" border="0" cellpadding="0" cellspacing="0" style="width:640px">
                        <tbody>
                            <tr>
                                <td style="padding: 15px 30px;">
                                    <table style="width: 100%; border: 1px solid #e0e0e0; border-radius: 8px; position: relative; ${highlightStyle}">
                                        <tr>
                                            <td style="padding: 20px; position: relative;">
                                                ${highlightBadge}
                                                <div style="position: absolute; top: 10px; left: 10px; background: #009a93; color: white; width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: bold;">
                                                    ${eventNumber}
                                                </div>
                                                <table style="margin-top: 10px;">
                                                    <tr>
                                                        <td style="width: 70px; vertical-align: top;">
                                                            <div style="background: #009a93; color: white; padding: 8px; border-radius: 4px; text-align: center; margin-left: 10px;">
                                                                <div style="font-size: 11px; text-transform: uppercase;">${event.month || 'TBD'}</div>
                                                                <div style="font-size: 20px; font-weight: bold;">${event.day || '?'}</div>
                                                            </div>
                                                        </td>
                                                        <td style="padding-left: 20px;">
                                                            <h3 style="color: #009a93; margin: 0 0 10px 0; font-size: 16px; line-height: 1.3;">${event.title}</h3>
                                                            ${event.time ? `<p style="margin: 5px 0; font-size: 14px;"><strong>‚è∞ Zeit:</strong> ${event.time}</p>` : ''}
                                                            ${event.location ? `<p style="margin: 5px 0; font-size: 14px;"><strong>üìç Ort:</strong> ${event.location}</p>` : ''}
                                                            ${event.description ? `<p style="margin: 10px 0 15px 0; font-size: 14px; line-height: 1.4; color: #555;">${event.description}</p>` : ''}
                                                            ${event.registrationLink ? `<a href="${event.registrationLink}" style="display: inline-block; background: #009a93; color: white; padding: 10px 20px; border-radius: 6px; font-weight: bold; text-decoration: none; font-size: 15px; margin-top: 10px;">üéØ Jetzt anmelden</a>` : ''}
                                                        </td>
                                                    </tr>
                                                </table>
                                            </td>
                                        </tr>
                                    </table>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                `;
            }

            setupModuleDragAndDrop(moduleElement) {
                moduleElement.addEventListener('dragstart', (e) => {
                    e.dataTransfer.effectAllowed = 'move';
                    e.dataTransfer.setData('moduleId', moduleElement.id);
                    e.dataTransfer.setData('action', 'move');
                    moduleElement.classList.add('dragging');
                });
                
                moduleElement.addEventListener('dragend', () => {
                    moduleElement.classList.remove('dragging');
                });
                
                moduleElement.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    const draggingElement = document.querySelector('.dragging');
                    if (draggingElement && draggingElement !== moduleElement) {
                        const rect = moduleElement.getBoundingClientRect();
                        const y = e.clientY - rect.top;
                        
                        if (y < rect.height / 2) {
                            moduleElement.style.borderTop = '2px solid #009a93';
                            moduleElement.style.borderBottom = '';
                        } else {
                            moduleElement.style.borderBottom = '2px solid #009a93';
                            moduleElement.style.borderTop = '';
                        }
                    }
                });
                
                moduleElement.addEventListener('dragleave', () => {
                    moduleElement.style.borderTop = '';
                    moduleElement.style.borderBottom = '';
                });
                
                moduleElement.addEventListener('drop', (e) => {
                    e.preventDefault();
                    moduleElement.style.borderTop = '';
                    moduleElement.style.borderBottom = '';
                    
                    const action = e.dataTransfer.getData('action');
                    
                    if (action === 'move') {
                        const draggedId = e.dataTransfer.getData('moduleId');
                        const draggedElement = document.getElementById(draggedId);
                        
                        if (draggedElement && draggedElement !== moduleElement) {
                            const rect = moduleElement.getBoundingClientRect();
                            const y = e.clientY - rect.top;
                            
                            if (y < rect.height / 2) {
                                moduleElement.parentNode.insertBefore(draggedElement, moduleElement);
                            } else {
                                moduleElement.parentNode.insertBefore(draggedElement, moduleElement.nextSibling);
                            }
                            
                            this.updateModulesOrder();
                        }
                    }
                });
            }

            updateModulesOrder() {
                const moduleElements = document.querySelectorAll('.template-module');
                const newOrder = [];
                
                moduleElements.forEach(element => {
                    const module = this.modules.find(m => m.id === element.id);
                    if (module) {
                        newOrder.push(module);
                    }
                });
                
                this.modules = newOrder;
                this.autoSave();
            }

            editModule(moduleId) {
                const module = this.modules.find(m => m.id === moduleId);
                if (!module) return;
                
                this.currentEditingModule = module;
                const template = MODULE_TEMPLATES[module.type];
                
                document.getElementById('moduleEditorTitle').textContent = `${template.title} bearbeiten`;
                
                // Build editor content
                let editorHTML = '<div id="contentTab" class="tab-content">';
                
                // Special handling for events module
                if (module.type === 'events') {
                    editorHTML += this.buildEventsEditor(module);
                } else {
                    template.fields.forEach(field => {
                        editorHTML += this.buildFieldEditor(field, module.fields[field.name]);
                    });
                }
                
                editorHTML += '</div>';
                editorHTML += '<div id="settingsTab" class="tab-content" style="display: none;">';
                editorHTML += '<p>Hier k√∂nnen Sie erweiterte Einstellungen vornehmen.</p>';
                editorHTML += '</div>';
                
                document.getElementById('moduleEditorContent').innerHTML = editorHTML;
                
                // Show modal
                document.getElementById('moduleEditorModal').style.display = 'block';
                document.getElementById('overlay').style.display = 'block';
                
                // Setup image upload buttons
                this.setupImageUploads();
            }

            buildEventsEditor(module) {
                let html = '<div class="field-group">';
                html += '<label for="eventsTitle">Events √úberschrift</label>';
                html += `<input type="text" id="eventsTitle" name="eventsTitle" value="${module.fields.eventsTitle || 'Unsere n√§chsten Events'}">`;
                html += '</div>';
                
                html += '<div class="field-group">';
                html += '<label>Events</label>';
                html += '<button class="primary-btn" onclick="templateBuilder.showEventImport()">üì• Events importieren</button>';
                html += '<div class="dynamic-items-list" style="margin-top: 15px;">';
                
                const events = module.fields.events || [];
                events.forEach((event, index) => {
                    html += this.buildEditorEventCard(event, index);
                });
                
                if (events.length === 0) {
                    html += '<p style="color: #666;">Keine Events vorhanden. Nutzen Sie den Import-Button oder f√ºgen Sie manuell Events hinzu.</p>';
                }
                
                html += '</div>';
                html += '<button class="secondary-btn" onclick="templateBuilder.addManualEvent()" style="margin-top: 10px;">+ Event manuell hinzuf√ºgen</button>';
                html += '</div>';
                
                return html;
            }

            buildEditorEventCard(event, index) {
            const personalizedTitle = this.cleanEventTitle(event.title);
            const personalizedDescription = event.description ? event.description : '';
            
            return `
                <div class="event-card" data-index="${index}">
                    <div class="event-card-header">
                        <div style="display: flex; align-items: start; gap: 15px; flex: 1;">
                            <div class="event-date-box">
                                <div class="event-date-month">${event.month || 'TBD'}</div>
                                <div class="event-date-day">${event.day || '?'}</div>
                            </div>
                            <div style="flex: 1;">
                                <input type="text" value="${personalizedTitle}" onchange="templateBuilder.updateEvent(${index}, 'title', this.value)" style="width: 100%; margin-bottom: 5px; font-weight: bold;" placeholder="Event Titel">
                                <input type="date" value="${event.date || ''}" onchange="templateBuilder.updateEvent(${index}, 'date', this.value)" style="width: 100%; margin-bottom: 5px;">
                                <input type="text" value="${event.time || ''}" onchange="templateBuilder.updateEvent(${index}, 'time', this.value)" style="width: 100%; margin-bottom: 5px;" placeholder="Uhrzeit (z.B. 18:00 Uhr)">
                                <input type="text" value="${event.location || ''}" onchange="templateBuilder.updateEvent(${index}, 'location', this.value)" style="width: 100%; margin-bottom: 5px;" placeholder="Ort">
                                <textarea onchange="templateBuilder.updateEvent(${index}, 'description', this.value)" style="width: 100%; margin-bottom: 5px;" placeholder="Beschreibung">${personalizedDescription}</textarea>
                                <input type="text" value="${event.registrationLink || ''}" onchange="templateBuilder.updateEvent(${index}, 'registrationLink', this.value)" style="width: 100%;" placeholder="Anmelde-Link (optional)">
                            </div>
                        </div>
                        <div class="event-badges">
                            ${event.category ? `<span class="badge badge-category">${event.category}</span>` : ''}
                            ${event.eventMode ? `<span class="badge badge-mode">${event.eventMode}</span>` : ''}
                            ${event.highlight ? `<span class="badge" style="background: #ffc107; color: #000;">‚≠ê HIGHLIGHT</span>` : ''}
                        </div>
                    </div>
                    <div style="margin-top: 10px; display: flex; justify-content: space-between; align-items: center; padding-top: 10px; border-top: 1px solid #e0e0e0;">
                        <label style="display: flex; align-items: center; cursor: pointer;">
                            <input type="checkbox" ${event.highlight ? 'checked' : ''} onchange="templateBuilder.updateEvent(${index}, 'highlight', this.checked)" style="margin-right: 8px; width: 18px; height: 18px; cursor: pointer;">
                            <span style="font-weight: bold; color: #ffc107;">‚≠ê Als Highlight markieren</span>
                        </label>
                        <button class="delete-module" onclick="templateBuilder.removeEvent(${index})">Event l√∂schen</button>
                    </div>
                </div>
            `;
        }

            showEventImport() {
                document.getElementById('eventImportModal').style.display = 'block';
                document.getElementById('overlay').style.display = 'block';
            }

            closeEventImport() {
                document.getElementById('eventImportModal').style.display = 'none';
                document.getElementById('overlay').style.display = 'none';
            }

            cleanEventTitle(title) {
                if (!title) return '';
                return title
                    .replace(/\n+/g, ' ')
                    .replace(/\s+/g, ' ')
                    .replace(/Anmeldungen?\s+(m√∂glich|geschlossen)/gi, '')
                    .replace(/Anmeldung\s+(m√∂glich|geschlossen)/gi, '')
                    .trim();
            }

            importPastedEvents() {
                const textarea = document.getElementById('pasteEventsArea');
                const jsonText = textarea.value.trim();
                
                if (!jsonText) {
                    this.showNotification('Bitte f√ºgen Sie die kopierten Events ein.', true);
                    return;
                }
                
                try {
                    const events = JSON.parse(jsonText);
                    
                    if (!Array.isArray(events)) {
                        throw new Error('Die Daten sind kein g√ºltiges Event-Array');
                    }
                    
                    // Filter out invalid events
                    const validEvents = events.filter(event => 
                        event.title && 
                        event.title.trim() !== '' && 
                        event.title !== 'Event' &&
                        event.title.length > 3
                    );
                    
                    if (validEvents.length === 0) {
                        this.showNotification('Keine g√ºltigen Events in den Daten gefunden', true);
                        return;
                    }
                    
                    // Remove duplicates
                    const uniqueEvents = validEvents.filter((event, index, self) => 
                        index === self.findIndex(e => 
                            e.title === event.title && 
                            e.time === event.time && 
                            e.date === event.date
                        )
                    );
                    
                    // Add events to current module
                    if (this.currentEditingModule) {
                        if (!this.currentEditingModule.fields.events) {
                            this.currentEditingModule.fields.events = [];
                        }
                        
                        // Process events for CleverReach personalization
                        uniqueEvents.forEach(event => {
                            if (event.title) {
                                event.title = this.cleanEventTitle(event.title).replace(/\{NAME\}/g, '{FIRSTNAME[std:Hi]}');
                            }
                            if (event.description) {
                                event.description = event.description.replace(/\{NAME\}/g, '{FIRSTNAME[std:Hi]}');
                            }
                            
                            // Ensure date fields are properly set
                            if (event.date && !event.month) {
                                const date = new Date(event.date);
                                const months = ['Jan', 'Feb', 'M√§r', 'Apr', 'Mai', 'Jun', 'Jul', 'Aug', 'Sep', 'Okt', 'Nov', 'Dez'];
                                event.month = months[date.getMonth()];
                                event.day = date.getDate().toString();
                            }
                        });
                        
                        // Ask if existing events should be kept
                        if (this.currentEditingModule.fields.events.length > 0) {
                            if (confirm(`Es sind bereits ${this.currentEditingModule.fields.events.length} Events vorhanden. M√∂chten Sie die neuen Events hinzuf√ºgen (OK) oder ersetzen (Abbrechen)?`)) {
                                this.currentEditingModule.fields.events.push(...uniqueEvents);
                            } else {
                                this.currentEditingModule.fields.events = uniqueEvents;
                            }
                        } else {
                            this.currentEditingModule.fields.events = uniqueEvents;
                        }
                        
                        // Clear textarea
                        textarea.value = '';
                        
                        // Refresh editor
                        this.editModule(this.currentEditingModule.id);
                        
                        this.showNotification(`${uniqueEvents.length} Events erfolgreich importiert! (${events.length - uniqueEvents.length} Duplikate/ung√ºltige Events entfernt)`, false, 'success');
                    }
                    
                } catch (error) {
                    console.error('Fehler beim Parsen der Events:', error);
                    this.showNotification('Fehler: Die eingef√ºgten Daten sind nicht im richtigen Format', true);
                }
            }

            cleanEventTitle(title) {
                if (!title) return '';
                return title
                    .replace(/\n/g, ' ')
                    .replace(/\s+/g, ' ')
                    .replace(/Anmeldungen? (m√∂glich|geschlossen)/gi, '')
                    .replace(/Anmeldung (m√∂glich|geschlossen)/gi, '')
                    .trim();
            }

            buildEventCard(event, index) {
                const eventNumber = index + 1;
                const isHighlighted = event.highlight || false;
                const highlightStyle = isHighlighted ? 'background: linear-gradient(135deg, #fff9e6 0%, #ffffff 100%); border: 2px solid #ffc107;' : '';
                const highlightBadge = isHighlighted ? '<div style="position: absolute; top: 10px; right: 10px; background: #ffc107; color: #000; padding: 4px 12px; border-radius: 12px; font-size: 11px; font-weight: bold;">‚≠ê HIGHLIGHT</div>' : '';
                
                return `
                    <table align="center" border="0" cellpadding="0" cellspacing="0" style="width:640px">
                        <tbody>
                            <tr>
                                <td style="padding: 15px 30px;">
                                    <table style="width: 100%; border: 1px solid #e0e0e0; border-radius: 8px; position: relative; ${highlightStyle}">
                                        <tr>
                                            <td style="padding: 20px; position: relative;">
                                                ${highlightBadge}
                                                <div style="position: absolute; top: 10px; left: 10px; background: #009a93; color: white; width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: bold;">
                                                    ${eventNumber}
                                                </div>
                                                <table style="margin-top: 10px;">
                                                    <tr>
                                                        <td style="width: 70px; vertical-align: top;">
                                                            <div style="background: #009a93; color: white; padding: 8px; border-radius: 4px; text-align: center; margin-left: 10px;">
                                                                <div style="font-size: 11px; text-transform: uppercase;">${event.month || 'TBD'}</div>
                                                                <div style="font-size: 20px; font-weight: bold;">${event.day || '?'}</div>
                                                            </div>
                                                        </td>
                                                        <td style="padding-left: 20px;">
                                                            <h3 style="color: #009a93; margin: 0 0 10px 0; font-size: 16px; line-height: 1.3;">${event.title}</h3>
                                                            ${event.time ? `<p style="margin: 5px 0; font-size: 14px;"><strong>‚è∞ Zeit:</strong> ${event.time}</p>` : ''}
                                                            ${event.location ? `<p style="margin: 5px 0; font-size: 14px;"><strong>üìç Ort:</strong> ${event.location}</p>` : ''}
                                                            ${event.description ? `<p style="margin: 10px 0 15px 0; font-size: 14px; line-height: 1.4; color: #555;">${event.description}</p>` : ''}
                                                            ${event.registrationLink ? `<a href="${event.registrationLink}" style="display: inline-block; background: #009a93; color: white; padding: 12px 24px; border-radius: 6px; font-weight: bold; text-decoration: none; font-size: 15px; margin-top: 12px;">üéØ Jetzt anmelden</a>` : ''}
                                                        </td>
                                                    </tr>
                                                </table>
                                            </td>
                                        </tr>
                                    </table>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                `;
            }

            buildFieldEditor(field, value) {
                let html = '<div class="field-group">';
                html += `<label for="${field.name}">${field.label}</label>`;
                
                switch (field.type) {
                    case 'textarea':
                        html += `<textarea id="${field.name}" name="${field.name}">${value || field.default}</textarea>`;
                        break;
                    case 'image':
                        html += `<input type="text" id="${field.name}" name="${field.name}" value="${value || field.default}">`;
                        html += `<button class="image-upload-btn" data-field="${field.name}">Bild hochladen</button>`;
                        if (value) {
                            html += `<div class="image-preview"><img src="${value}" alt="Vorschau"></div>`;
                        }
                        break;
                    case 'select':
                        html += `<select id="${field.name}" name="${field.name}">`;
                        field.options.forEach(option => {
                            html += `<option value="${option}" ${(value || field.default) === option ? 'selected' : ''}>${option}</option>`;
                        });
                        html += '</select>';
                        break;
                    case 'number':
                        html += `<input type="number" id="${field.name}" name="${field.name}" value="${value || field.default}">`;
                        break;
                    default:
                        html += `<input type="text" id="${field.name}" name="${field.name}" value="${value || field.default}">`;
                }
                
                html += '</div>';
                return html;
            }

            setupImageUploads() {
                document.querySelectorAll('.image-upload-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const fieldName = e.target.dataset.field;
                        this.uploadImage(fieldName);
                    });
                });
            }

            uploadImage(fieldName) {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = 'image/*';
                
                input.addEventListener('change', (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            const dataUrl = e.target.result;
                            document.getElementById(fieldName).value = dataUrl;
                            
                            // Update preview
                            let preview = document.querySelector(`#${fieldName}`).parentElement.querySelector('.image-preview');
                            if (!preview) {
                                preview = document.createElement('div');
                                preview.className = 'image-preview';
                                document.querySelector(`#${fieldName}`).parentElement.appendChild(preview);
                            }
                            preview.innerHTML = `<img src="${dataUrl}" alt="Vorschau">`;
                        };
                        reader.readAsDataURL(file);
                    }
                });
                
                input.click();
            }

            addManualEvent() {
                if (!this.currentEditingModule) return;
                
                const today = new Date();
                const months = ['Jan', 'Feb', 'M√§r', 'Apr', 'Mai', 'Jun', 'Jul', 'Aug', 'Sep', 'Okt', 'Nov', 'Dez'];
                
                const newEvent = {
                    title: 'Neues Event - {FIRSTNAME[std:Hi]}, sei dabei!',
                    month: months[today.getMonth()],
                    day: today.getDate().toString(),
                    date: today.toISOString().split('T')[0],
                    time: '18:00 - 20:00 Uhr',
                    location: 'Berlin',
                    description: 'Beschreibung des Events hier eingeben...',
                    category: 'Community Event',
                    eventMode: 'Offline',
                    registrationLink: 'https://portal.startwithafriend.de/events'
                };
                
                if (!this.currentEditingModule.fields.events) {
                    this.currentEditingModule.fields.events = [];
                }
                
                this.currentEditingModule.fields.events.push(newEvent);
                
                // Refresh editor
                this.editModule(this.currentEditingModule.id);
            }

            updateEvent(index, field, value) {
                if (this.currentEditingModule && this.currentEditingModule.fields.events) {
                    this.currentEditingModule.fields.events[index][field] = value;
                    
                    // Update date display if date field is changed
                    if (field === 'date' && value) {
                        const date = new Date(value);
                        const months = ['Jan', 'Feb', 'M√§r', 'Apr', 'Mai', 'Jun', 'Jul', 'Aug', 'Sep', 'Okt', 'Nov', 'Dez'];
                        this.currentEditingModule.fields.events[index].month = months[date.getMonth()];
                        this.currentEditingModule.fields.events[index].day = date.getDate().toString();
                        
                        // Update the display immediately
                        const eventCard = document.querySelector(`.event-card[data-index="${index}"]`);
                        if (eventCard) {
                            const monthElement = eventCard.querySelector('.event-date-month');
                            const dayElement = eventCard.querySelector('.event-date-day');
                            if (monthElement) monthElement.textContent = months[date.getMonth()];
                            if (dayElement) dayElement.textContent = date.getDate().toString();
                        }
                    }
                }
            }

            removeEvent(index) {
                if (this.currentEditingModule && this.currentEditingModule.fields.events) {
                    this.currentEditingModule.fields.events.splice(index, 1);
                    
                    // Refresh editor
                    this.editModule(this.currentEditingModule.id);
                }
            }

            switchTab(tabName) {
                document.querySelectorAll('.module-editor-tab').forEach(tab => {
                    tab.classList.remove('active');
                });
                document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
                
                document.getElementById('contentTab').style.display = tabName === 'content' ? 'block' : 'none';
                document.getElementById('settingsTab').style.display = tabName === 'settings' ? 'block' : 'none';
            }

            saveModuleEdit() {
                if (!this.currentEditingModule) return;
                
                const template = MODULE_TEMPLATES[this.currentEditingModule.type];
                
                // Save regular fields
                template.fields.forEach(field => {
                    if (field.type !== 'dynamic-list') {
                        const input = document.getElementById(field.name);
                        if (input) {
                            this.currentEditingModule.fields[field.name] = input.value;
                        }
                    }
                });
                
                // Update module display
                const moduleElement = document.getElementById(this.currentEditingModule.id);
                if (moduleElement) {
                    const contentElement = moduleElement.querySelector('.module-content');
                    contentElement.innerHTML = this.renderModuleContent(this.currentEditingModule);
                }
                
                this.closeModuleEditor();
                this.autoSave();
                this.showNotification('Modul aktualisiert');
            }

            closeModuleEditor() {
                document.getElementById('moduleEditorModal').style.display = 'none';
                document.getElementById('overlay').style.display = 'none';
                this.currentEditingModule = null;
            }

            duplicateModule(moduleId) {
                const module = this.modules.find(m => m.id === moduleId);
                if (!module) return;
                
                const newModule = JSON.parse(JSON.stringify(module));
                newModule.id = `module-${++this.moduleCounter}`;
                
                const index = this.modules.indexOf(module);
                this.modules.splice(index + 1, 0, newModule);
                
                const moduleElement = document.getElementById(moduleId);
                const newElement = moduleElement.cloneNode(true);
                newElement.id = newModule.id;
                
                // Update event handlers
                newElement.querySelector('.edit-module').setAttribute('onclick', `templateBuilder.editModule('${newModule.id}')`);
                newElement.querySelector('.duplicate-module').setAttribute('onclick', `templateBuilder.duplicateModule('${newModule.id}')`);
                newElement.querySelector('.delete-module').setAttribute('onclick', `templateBuilder.deleteModule('${newModule.id}')`);
                newElement.querySelector('.move-up').setAttribute('onclick', `templateBuilder.moveModuleUp('${newModule.id}')`);
                newElement.querySelector('.move-down').setAttribute('onclick', `templateBuilder.moveModuleDown('${newModule.id}')`);
                
                moduleElement.parentNode.insertBefore(newElement, moduleElement.nextSibling);
                this.setupModuleDragAndDrop(newElement);
                
                this.autoSave();
                this.showNotification('Modul dupliziert');
            }

            deleteModule(moduleId) {
                if (!confirm('M√∂chten Sie dieses Modul wirklich l√∂schen?')) return;
                
                const index = this.modules.findIndex(m => m.id === moduleId);
                if (index > -1) {
                    this.modules.splice(index, 1);
                    document.getElementById(moduleId).remove();
                    
                    if (this.modules.length === 0) {
                        document.getElementById('previewContent').innerHTML = `
                            <div style="padding: 40px; text-align: center; color: #999;">
                                <p>Ziehen Sie Module aus der Seitenleiste hierher, um Ihr Template zu erstellen.</p>
                            </div>
                        `;
                    }
                    
                    this.autoSave();
                    this.showNotification('Modul gel√∂scht');
                }
            }

            newTemplate() {
                if (this.modules.length > 0) {
                    if (!confirm('Alle nicht gespeicherten √Ñnderungen gehen verloren. Fortfahren?')) {
                        return;
                    }
                }
                
                this.modules = [];
                this.moduleCounter = 0;
                document.getElementById('templateTitle').value = '';
                document.getElementById('previewContent').innerHTML = `
                    <div style="padding: 40px; text-align: center; color: #999;">
                        <p>Ziehen Sie Module aus der Seitenleiste hierher, um Ihr Template zu erstellen.</p>
                    </div>
                `;
                
                localStorage.removeItem('swafTemplateAutoSave');
                this.showNotification('Neues Template erstellt');
            }

            clearTemplate() {
                if (confirm('M√∂chten Sie wirklich alle Module entfernen?')) {
                    this.modules = [];
                    document.getElementById('previewContent').innerHTML = `
                        <div style="padding: 40px; text-align: center; color: #999;">
                            <p>Ziehen Sie Module aus der Seitenleiste hierher, um Ihr Template zu erstellen.</p>
                        </div>
                    `;
                    this.autoSave();
                    this.showNotification('Template geleert');
                }
            }

            saveTemplate() {
                const templateName = document.getElementById('templateTitle').value || 'Unbenanntes Template';
                const templateData = {
                    name: templateName,
                    modules: this.modules,
                    savedAt: new Date().toISOString()
                };
                
                // Get existing templates
                const templates = JSON.parse(localStorage.getItem('swafTemplates') || '[]');
                
                // Check if template with same name exists
                const existingIndex = templates.findIndex(t => t.name === templateName);
                
                if (existingIndex > -1) {
                    if (confirm('Ein Template mit diesem Namen existiert bereits. √úberschreiben?')) {
                        templates[existingIndex] = templateData;
                    } else {
                        return;
                    }
                } else {
                    templates.push(templateData);
                }
                
                localStorage.setItem('swafTemplates', JSON.stringify(templates));
                this.showNotification('Template gespeichert');
            }

            loadTemplate() {
                const templates = JSON.parse(localStorage.getItem('swafTemplates') || '[]');
                
                if (templates.length === 0) {
                    this.showNotification('Keine gespeicherten Templates vorhanden', true);
                    return;
                }
                
                // Create a simple selection dialog
                const templateList = templates.map((t, i) => `${i + 1}. ${t.name} (${new Date(t.savedAt).toLocaleDateString()})`).join('\n');
                const selection = prompt(`W√§hlen Sie ein Template (Nummer eingeben):\n\n${templateList}`);
                
                if (selection) {
                    const index = parseInt(selection) - 1;
                    if (templates[index]) {
                        this.loadTemplateData(templates[index]);
                    }
                }
            }

            loadTemplateData(templateData) {
                this.modules = templateData.modules;
                document.getElementById('templateTitle').value = templateData.name;
                
                // Clear and rebuild preview
                document.getElementById('previewContent').innerHTML = '';
                this.modules.forEach(module => {
                    this.renderModule(module);
                });
                
                this.showNotification('Template geladen');
            }

            exportJSON() {
                const templateData = {
                    name: document.getElementById('templateTitle').value || 'template',
                    modules: this.modules,
                    exportedAt: new Date().toISOString(),
                    version: '1.0'
                };
                
                const dataStr = JSON.stringify(templateData, null, 2);
                const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
                
                const exportLink = document.createElement('a');
                exportLink.setAttribute('href', dataUri);
                exportLink.setAttribute('download', `${templateData.name.replace(/\s+/g, '_')}.json`);
                exportLink.click();
                
                this.showNotification('Template als JSON exportiert');
            }

            importJSON() {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = '.json';
                
                input.addEventListener('change', (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            try {
                                const templateData = JSON.parse(e.target.result);
                                this.loadTemplateData(templateData);
                            } catch (error) {
                                this.showNotification('Fehler beim Importieren der Datei', true);
                            }
                        };
                        reader.readAsText(file);
                    }
                });
                
                input.click();
            }

            generateHTML() {
                const html = this.buildCompleteHTML();
                
                // Create download link
                const blob = new Blob([html], { type: 'text/html' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `${document.getElementById('templateTitle').value || 'newsletter'}.html`;
                link.click();
                
                URL.revokeObjectURL(url);
                this.showNotification('HTML generiert und heruntergeladen');
            }

            copyHTML() {
                const html = this.buildCompleteHTML();
                this.currentHTML = html;
                
                // Copy to clipboard
                navigator.clipboard.writeText(html).then(() => {
                    // Show modal with preview
                    document.getElementById('htmlPreview').textContent = html;
                    document.getElementById('copyHTMLModal').style.display = 'block';
                    document.getElementById('overlay').style.display = 'block';
                    
                    this.showNotification('HTML in Zwischenablage kopiert!', false, 'success');
                }).catch(err => {
                    console.error('Fehler beim Kopieren:', err);
                    // Fallback: Show in modal for manual copy
                    document.getElementById('htmlPreview').textContent = html;
                    document.getElementById('copyHTMLModal').style.display = 'block';
                    document.getElementById('overlay').style.display = 'block';
                    
                    this.showNotification('Bitte kopieren Sie den HTML-Code manuell', true);
                });
            }

            copyHTMLAgain() {
                navigator.clipboard.writeText(this.currentHTML).then(() => {
                    this.showNotification('HTML erneut kopiert!', false, 'success');
                }).catch(err => {
                    this.showNotification('Bitte markieren und kopieren Sie den Code manuell', true);
                });
            }

            closeCopyHTML() {
                document.getElementById('copyHTMLModal').style.display = 'none';
                document.getElementById('overlay').style.display = 'none';
            }

            buildCompleteHTML() {
                let html = `<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>${document.getElementById('templateTitle').value || 'Newsletter'}</title>
    <style type="text/css">
        body { margin: 0; padding: 0; font-family: 'GT Walsheim', Arial, sans-serif; }
        table { border-collapse: collapse; }
        td { padding: 0; }
        img { border: 0; display: block; }
    </style>
    <style type="text/css">
        @media only screen and (max-width: 640px) {
            table[style*="width:640px"], table[class="email-container"] {
                width: 100% !important;
            }
            h2 {
                font-size: 20px !important;
            }
            h3 {
                font-size: 14px !important;
            }
            a[style*="inline-block"] {
                display: block !important;
                text-align: center !important;
            }
        }
    </style>
</head>
<body style="margin: 0; padding: 0; background-color: #f5f5f5;">
    <center>
        <table border="0" cellpadding="0" cellspacing="0" width="100%" style="background-color: #f5f5f5;">
            <tr>
                <td align="center" valign="top">`;
                
                // Zuerst: Pflicht-Module am Anfang (Preheader, Header)
                const mandatoryStart = ['preheader', 'header'];
                const mandatoryEnd = ['footer-imprint', 'unsubscribe'];

                // Module sortieren
                const startModules = this.modules.filter(m => mandatoryStart.includes(m.type));
                const contentModules = this.modules.filter(m => !mandatoryStart.includes(m.type) && !mandatoryEnd.includes(m.type));
                const endModules = this.modules.filter(m => mandatoryEnd.includes(m.type));

                // Render in richtiger Reihenfolge
                [...startModules, ...contentModules, ...endModules].forEach(module => {
                    html += this.renderModuleContent(module);
                });
                
                html += `
                </td>
            </tr>
        </table>
    <!-- Abmelde-Link -->
                    <table border="0" cellpadding="0" cellspacing="0" width="100%" style="background-color: #ffffff;">
                        <tr>
                            <td align="center" style="padding: 20px 30px;">
                                <div style="font-size: 12px; color: #666; text-align: center; border-top: 1px solid #e0e0e0; padding-top: 20px;">
                                    Wenn du diese E-Mail (an: {EMAIL}) nicht mehr empfangen m√∂chtest, kannst du <strong>sie </strong>
                                    <a href="https://newsletter.start-with-a-friend.de/rmftlp.php?cid=[CTID]&mid=[MAILING_ID]&h=[CTID]-[USER_ID_SECURE]" 
                                       style="color: #009a93; text-decoration: underline;">
                                        <strong>hier</strong>
                                    </a> abbestellen.
                                </div>
                            </td>
                        </tr>
                    </table>
                </td>
            </tr>
        </table>
    </center>
</body>
</html>`;
                
                return html;
            }

            showPreview() {
                const html = this.buildCompleteHTML();
                const iframe = document.getElementById('previewFrame');
                
                iframe.srcdoc = html;
                document.getElementById('previewModal').style.display = 'block';
                document.getElementById('overlay').style.display = 'block';
            }

            closePreview() {
                document.getElementById('previewModal').style.display = 'none';
                document.getElementById('overlay').style.display = 'none';
            }

            autoSave() {
                const autoSaveData = {
                    name: document.getElementById('templateTitle').value,
                    modules: this.modules,
                    savedAt: new Date().toISOString()
                };
                
                localStorage.setItem('swafTemplateAutoSave', JSON.stringify(autoSaveData));
            }

            loadAutoSave() {
                const autoSaveData = localStorage.getItem('swafTemplateAutoSave');
                
                if (autoSaveData) {
                    try {
                        const data = JSON.parse(autoSaveData);
                        
                        if (confirm('Es wurde eine automatisch gespeicherte Version gefunden. M√∂chten Sie diese laden?')) {
                            this.loadTemplateData(data);
                        }
                    } catch (error) {
                        console.error('Error loading autosave:', error);
                    }
                }
            }

            showNotification(message, isError = false, type = null) {
                const notification = document.createElement('div');
                notification.className = 'notification';
                
                if (isError) {
                    notification.className += ' error';
                } else if (type === 'success') {
                    notification.className += ' success';
                }
                
                notification.textContent = message;
                
                document.body.appendChild(notification);
                
                setTimeout(() => {
                    notification.remove();
                }, 3000);
            }
        }

        // Initialize the application
        const templateBuilder = new TemplateBuilder();
    </script>
<!-- Help Modal -->
<div id="helpModal" class="modal">
    <div class="modal-content" style="max-width: 800px;">
        <div class="modal-header">
            <h2>üìö Newsletter Builder Anleitung</h2>
        </div>
        <div style="padding: 0 24px 24px;">
            <h3 style="color: #009a93; margin-top: 20px;">üöÄ Wie nutze ich den Editor?</h3>
            <ol style="line-height: 1.8;">
                <li><strong>Module hinzuf√ºgen:</strong> Ziehen Sie Module aus der linken Sidebar in den Vorschau-Bereich</li>
                <li><strong>Bearbeiten:</strong> Klicken Sie auf "‚úé Bearbeiten" um Inhalte anzupassen</li>
                <li><strong>Reihenfolge √§ndern:</strong> Nutzen Sie ‚Üë‚Üì oder ziehen Sie Module per Drag & Drop</li>
                <li><strong>Events importieren:</strong> Klicken Sie im Events-Modul auf "üì• Events importieren"</li>
            </ol>

            <h3 style="color: #009a93; margin-top: 20px;">üì• Events vom Portal importieren</h3>
            <ol style="line-height: 1.8;">
                <li>Ziehen Sie das Bookmarklet in Ihre Lesezeichen-Leiste</li>
                <li>√ñffnen Sie <a href="https://portal.startwithafriend.de/events" target="_blank">portal.startwithafriend.de/events</a></li>
                <li>Klicken Sie auf das Bookmarklet ‚Üí Events werden in Zwischenablage kopiert</li>
                <li>F√ºgen Sie die Events im Editor ein (Strg+V)</li>
            </ol>

            <h3 style="color: #009a93; margin-top: 20px;">üì§ Newsletter in CleverReach einf√ºgen</h3>
            <ol style="line-height: 1.8;">
                <li>Klicken Sie auf "üìã HTML kopieren" (oben rechts im Editor)</li>
                <li>Gehen Sie zu CleverReach ‚Üí Neuen Newsletter erstellen</li>
                <li>W√§hlen Sie "HTML-Editor" als Template-Typ</li>
                <li>F√ºgen Sie den kopierten HTML-Code ein (Strg+V)</li>
                <li>Speichern und Vorschau pr√ºfen</li>
            </ol>

            <h3 style="color: #009a93; margin-top: 20px;">üíæ Vorlagen speichern</h3>
            <ol style="line-height: 1.8;">
                <li><strong>Speichern:</strong> Klicken Sie auf "Speichern" ‚Üí Name eingeben ‚Üí Im Browser gespeichert</li>
                <li><strong>Laden:</strong> Klicken Sie auf "Laden" ‚Üí Vorlage ausw√§hlen</li>
                <li><strong>Export JSON:</strong> Als Datei exportieren (zur Weitergabe/Backup)</li>
                <li><strong>Import JSON:</strong> JSON-Datei importieren</li>
            </ol>

            <h3 style="color: #009a93; margin-top: 20px;">üí° Tipps</h3>
            <ul style="line-height: 1.8;">
                <li>Pflicht-Module (Preheader, Header, Footer) werden automatisch sortiert</li>
                <li>Nutzen Sie <code>{FIRSTNAME[std:Hi]}</code> f√ºr Personalisierung in CleverReach</li>
                <li>Markieren Sie wichtige Events als "‚≠ê Highlight"</li>
                <li>Testen Sie den Newsletter auf Mobile (F12 ‚Üí Handy-Symbol)</li>
            </ul>
        </div>
        <div class="modal-actions">
            <button class="primary-btn" id="closeHelp">Verstanden</button>
        </div>
    </div>
</div>

</body>
</html>
