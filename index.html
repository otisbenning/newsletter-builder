<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Start with a Friend Newsletter Builder</title>
    
    <!-- Cropper.js CDN -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.js"></script>
    
    <style>
        /* Reset und Basis-Styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            --primary-color: #009a93;
            --secondary-color: #00989a;
            --accent-color: #c5003d;
            --dark-color: #213293;
            font-family: 'GT Walsheim', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
            background-color: #f5f5f5;
            height: 100vh;
            overflow: hidden;
        }

        /* App Container */
        .app-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            background-color: white;
        }

        /* Header */
        header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        header h1 {
            font-size: 20px;
            font-weight: 600;
            display: flex;
            align-items: center;
        }

        .app-logo {
            height: 36px;
            margin-right: 10px;
            filter: brightness(0) invert(1);
        }

        .header-buttons {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .header-buttons button {
            padding: 8px 16px;
            background-color: rgba(255,255,255,0.2);
            color: white;
            border: 1px solid rgba(255,255,255,0.3);
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s;
        }

        .header-buttons button:hover {
            background-color: rgba(255,255,255,0.3);
            transform: translateY(-2px);
        }

        .header-button-separator {
            width: 1px;
            height: 24px;
            background-color: rgba(255,255,255,0.3);
            margin: 0 8px;
        }

        /* Main Content */
        .main-content {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        /* Sidebar */
        .sidebar {
            width: 280px;
            background-color: #f8f9fa;
            border-right: 1px solid #e0e0e0;
            padding: 20px;
            overflow-y: auto;
        }

        .sidebar h3 {
            font-size: 14px;
            color: #666;
            text-transform: uppercase;
            margin-bottom: 15px;
            font-weight: 600;
        }

        .module {
            background-color: white;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 10px;
            cursor: move;
            transition: all 0.3s;
            position: relative;
        }

        .module:hover {
            border-color: var(--primary-color);
            transform: translateX(5px);
            box-shadow: 0 2px 8px rgba(0,153,147,0.2);
        }

        .module-drag-handle {
            position: absolute;
            left: 8px;
            top: 50%;
            transform: translateY(-50%);
            color: #999;
        }

        .module-drag-handle::after {
            content: "≡";
        }

        .module-title {
            margin-left: 20px;
            font-weight: 500;
            color: #333;
        }

        /* Template Editor */
        .template-editor {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .template-header {
            background-color: white;
            padding: 15px 20px;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        #templateTitle {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        /* Preview Area */
        .preview-area {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background: linear-gradient(to bottom, #f9f9f9, #ffffff);
        }

        .preview-content {
            max-width: 800px;
            margin: 0 auto;
            background-color: white;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
            min-height: 100%;
        }

        /* Template Module */
        .template-module {
            position: relative;
            margin: 16px 0;
            border: 1px solid #ddd;
            border-radius: 6px;
            background-color: white;
            transition: all 0.2s;
        }

        .template-module:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            border-color: var(--primary-color);
        }

        .module-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 16px;
            background-color: #f8f9fa;
            border-bottom: 1px solid #ddd;
            border-radius: 6px 6px 0 0;
            cursor: move;
        }

        .module-actions {
            display: flex;
            gap: 6px;
        }

        .module-actions button {
            padding: 4px 8px;
            font-size: 12px;
            border: 1px solid #ddd;
            background: white;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .module-actions button:hover {
            background-color: #f0f0f0;
        }

        .move-up, .move-down {
            color: #666;
            padding: 4px 6px !important;
            font-size: 16px !important;
        }

        .edit-module {
            color: #0066cc;
        }

        .duplicate-module {
            color: #28a745;
        }

        .delete-module {
            color: #dc3545;
        }

        .module-content {
            padding: 16px;
        }

        /* Editor Actions */
        .editor-actions {
            padding: 12px 16px;
            border-top: 1px solid #e5e5e5;
            display: flex;
            justify-content: space-between;
            gap: 10px;
            background-color: white;
        }

        /* Buttons */
        .primary-btn {
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 6px;
            padding: 10px 20px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .primary-btn:hover {
            background-color: #007a73;
            transform: translateY(-2px);
        }

        .secondary-btn {
            background-color: white;
            color: var(--primary-color);
            border: 1px solid var(--primary-color);
            border-radius: 6px;
            padding: 10px 20px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .secondary-btn:hover {
            background-color: var(--primary-color);
            color: white;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            z-index: 1001;
            max-width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-content {
            padding: 24px;
            min-width: 500px;
        }

        .modal-header {
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 1px solid #eee;
        }

        .modal h2 {
            color: var(--primary-color);
            font-size: 20px;
            font-weight: 600;
        }

        .modal-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
        }

        /* Field Groups */
        .field-group {
            margin-bottom: 20px;
        }

        .field-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            color: #333;
            font-size: 14px;
        }

        .field-group input,
        .field-group textarea,
        .field-group select {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            font-family: inherit;
        }

        .field-group textarea {
            min-height: 100px;
            resize: vertical;
        }

        /* Tabs */
        .module-editor-tabs {
            display: flex;
            border-bottom: 1px solid #ddd;
            margin-bottom: 20px;
        }

        .module-editor-tab {
            padding: 10px 20px;
            background: none;
            border: none;
            border-bottom: 2px solid transparent;
            cursor: pointer;
            font-weight: 500;
            color: #666;
            transition: all 0.2s;
        }

        .module-editor-tab.active {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
        }

        /* Dynamic Items List */
        .dynamic-items-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .event-card {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            position: relative;
        }

        .event-card-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 10px;
        }

        .event-date-box {
            background: var(--primary-color);
            color: white;
            padding: 8px;
            border-radius: 4px;
            text-align: center;
            min-width: 50px;
        }

        .event-date-month {
            font-size: 11px;
            text-transform: uppercase;
        }

        .event-date-day {
            font-size: 20px;
            font-weight: bold;
        }

        .event-badges {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
        }

        .badge {
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 500;
            color: white;
        }

        .badge-category {
            background: var(--secondary-color);
        }

        .badge-mode {
            background: var(--accent-color);
        }

        .badge-location {
            background: var(--dark-color);
        }

        /* Bookmarklet Box */
        .bookmarklet-box {
            background: #f8f9fa;
            border: 2px dashed var(--primary-color);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .bookmarklet-link {
            display: inline-block;
            background: var(--primary-color);
            color: white;
            padding: 10px 20px;
            border-radius: 6px;
            text-decoration: none;
            font-weight: bold;
            margin: 10px 0;
        }

        .bookmarklet-link:hover {
            background: #007a73;
        }

        /* Paste Events Box */
        .paste-events-box {
            border: 2px solid #ddd;
            border-radius: 4px;
            padding: 10px;
            margin: 15px 0;
            background: #f9f9f9;
        }

        .paste-events-textarea {
            width: 100%;
            min-height: 150px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            margin-bottom: 10px;
        }

        /* Copy HTML Box */
        .copy-html-box {
            background: #f0f0f0;
            padding: 10px;
            border-radius: 4px;
            margin-top: 10px;
        }

        .html-preview {
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 10px;
            max-height: 300px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 11px;
            white-space: pre-wrap;
            word-break: break-all;
            margin-bottom: 10px;
        }

        /* Image Upload */
        .image-upload-btn {
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 4px;
            padding: 8px 12px;
            cursor: pointer;
            font-weight: 500;
            transition: background-color 0.2s;
            margin-top: 10px;
        }

        .image-upload-btn:hover {
            background-color: #007a73;
        }

        .image-preview {
            margin-top: 10px;
            max-width: 200px;
            max-height: 100px;
            overflow: hidden;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .image-preview img {
            max-width: 100%;
            max-height: 100px;
            display: block;
        }

        /* Overlay */
        #overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
        }

        /* Notification */
        .notification {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 16px 20px;
            background-color: var(--primary-color);
            color: white;
            border-radius: 6px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            z-index: 2000;
            animation: slideIn 0.3s ease;
        }

        .notification.error {
            background-color: var(--accent-color);
        }

        .notification.success {
            background-color: #28a745;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* Drag & Drop */
        .dragging {
            opacity: 0.5;
        }

        .drag-over {
            border: 2px dashed var(--primary-color);
            background-color: rgba(0, 153, 147, 0.05);
        }

        /* Responsive */
        @media (max-width: 992px) {
            .main-content {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                max-height: 200px;
                border-right: none;
                border-bottom: 1px solid #e0e0e0;
            }
        }

        @media (max-width: 768px) {
            .header-buttons {
                flex-wrap: wrap;
                gap: 5px;
            }
            
            .modal-content {
                min-width: auto;
                width: 95vw;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <header>
            <h1>
                <img src="https://www.start-with-a-friend.de/wp-content/uploads/2023/05/start-with-a-friend-mobile-logo-1-ai-1.svg" 
                     alt="Start with a Friend" class="app-logo">
                Newsletter Builder
            </h1>
            <div class="header-buttons">
                <button id="newTemplateBtn" title="Neues Template">Neu</button>
                <button id="saveTemplateBtn" title="Template speichern">Speichern</button>
                <button id="loadTemplateBtn" title="Template laden">Laden</button>
                <div class="header-button-separator"></div>
                <button id="exportTemplateBtn" title="Als JSON exportieren">Export JSON</button>
                <button id="importTemplateBtn" title="JSON importieren">Import JSON</button>
                <div class="header-button-separator"></div>
                <button id="previewBtn" title="Vorschau">Vorschau</button>
                <button id="copyHTMLBtn" title="HTML kopieren">📋 HTML kopieren</button>
            </div>
        </header>

        <div class="main-content">
            <aside class="sidebar">
                <h3>Pflicht-Module</h3>
                <div class="modules-list">
                    <div class="module" draggable="true" data-module-type="preheader">
                        <span class="module-drag-handle"></span>
                        <span class="module-title">Preheader</span>
                    </div>
                    <div class="module" draggable="true" data-module-type="header">
                        <span class="module-drag-handle"></span>
                        <span class="module-title">Header (Logo)</span>
                    </div>
                    <div class="module" draggable="true" data-module-type="footer-imprint">
                        <span class="module-drag-handle"></span>
                        <span class="module-title">Footer/Impressum</span>
                    </div>
                    <div class="module" draggable="true" data-module-type="unsubscribe">
                        <span class="module-drag-handle"></span>
                        <span class="module-title">Abmelde-Link</span>
                    </div>
                </div>
                
                <h3 style="margin-top: 20px;">Inhalts-Module</h3>
                <div class="modules-list">
                    <div class="module" draggable="true" data-module-type="hero-image">
                        <span class="module-drag-handle"></span>
                        <span class="module-title">Hero Bild</span>
                    </div>
                    <div class="module" draggable="true" data-module-type="greeting">
                        <span class="module-drag-handle"></span>
                        <span class="module-title">Begrüßung</span>
                    </div>
                    <div class="module" draggable="true" data-module-type="image-text">
                        <span class="module-drag-handle"></span>
                        <span class="module-title">Bild & Text</span>
                    </div>
                    <div class="module" draggable="true" data-module-type="text-only">
                        <span class="module-drag-handle"></span>
                        <span class="module-title">Nur Text</span>
                    </div>
                    <div class="module" draggable="true" data-module-type="events">
                        <span class="module-drag-handle"></span>
                        <span class="module-title">Events</span>
                    </div>
                    <div class="module" draggable="true" data-module-type="two-columns">
                        <span class="module-drag-handle"></span>
                        <span class="module-title">Zwei Spalten</span>
                    </div>
                    <div class="module" draggable="true" data-module-type="three-columns">
                        <span class="module-drag-handle"></span>
                        <span class="module-title">Drei Spalten</span>
                    </div>
                    <div class="module" draggable="true" data-module-type="quote">
                        <span class="module-drag-handle"></span>
                        <span class="module-title">Zitat</span>
                    </div>
                    <div class="module" draggable="true" data-module-type="cta-section">
                        <span class="module-drag-handle"></span>
                        <span class="module-title">Call-to-Action</span>
                    </div>
                    <div class="module" draggable="true" data-module-type="button-center">
                        <span class="module-drag-handle"></span>
                        <span class="module-title">Button (zentriert)</span>
                    </div>
                    <div class="module" draggable="true" data-module-type="social-media">
                        <span class="module-drag-handle"></span>
                        <span class="module-title">Social Media</span>
                    </div>
                    <div class="module" draggable="true" data-module-type="contact-person">
                        <span class="module-drag-handle"></span>
                        <span class="module-title">Ansprechpartner</span>
                    </div>
                    <div class="module" draggable="true" data-module-type="partner-news">
                        <span class="module-drag-handle"></span>
                        <span class="module-title">Partner News</span>
                    </div>
                    <div class="module" draggable="true" data-module-type="divider">
                        <span class="module-drag-handle"></span>
                        <span class="module-title">Trennlinie</span>
                    </div>
                </div>
            </aside>

            <main class="template-editor">
                <div class="template-header">
                    <label for="templateTitle">Template Name:</label>
                    <input type="text" id="templateTitle" placeholder="Newsletter Template Name">
                </div>
                <div class="preview-area">
                    <div class="preview-content" id="previewContent">
                        <!-- Template modules will be added here -->
                        <div style="padding: 40px; text-align: center; color: #999;">
                            <p>Ziehen Sie Module aus der Seitenleiste hierher, um Ihr Template zu erstellen.</p>
                        </div>
                    </div>
                </div>
                <div class="editor-actions">
                    <div>
                        <button class="secondary-btn" id="clearTemplateBtn">Template leeren</button>
                    </div>
                    <div>
                        <button class="primary-btn" id="generateHTMLBtn">HTML als Datei exportieren</button>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Module Editor Modal -->
    <div id="moduleEditorModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="moduleEditorTitle">Modul bearbeiten</h2>
            </div>
            <div class="module-editor-tabs">
                <button class="module-editor-tab active" data-tab="content">Inhalt</button>
                <button class="module-editor-tab" data-tab="settings">Einstellungen</button>
            </div>
            <div id="moduleEditorContent">
                <!-- Dynamic content will be inserted here -->
            </div>
            <div class="modal-actions">
                <button class="secondary-btn" id="cancelModuleEdit">Abbrechen</button>
                <button class="primary-btn" id="saveModuleEdit">Speichern</button>
            </div>
        </div>
    </div>

    <!-- Event Import Modal -->
    <div id="eventImportModal" class="modal">
        <div class="modal-content" style="min-width: 600px;">
            <div class="modal-header">
                <h2>Events importieren</h2>
            </div>
            
            <div class="bookmarklet-box">
                <h3>1. Bookmarklet installieren</h3>
                <p>Ziehen Sie diesen Button in Ihre Lesezeichen-Leiste:</p>
                <a href="javascript:(function(){var events=[];document.querySelectorAll('[class*=&quot;event&quot;],[class*=&quot;Event&quot;],article,.card,.list-item').forEach(function(el){var event={};var dateMatch=(el.textContent||'').match(/(\d{1,2})\.(\d{1,2})\.(\d{2,4})/);if(dateMatch){var date=new Date(parseInt(dateMatch[3])<100?2000+parseInt(dateMatch[3]):dateMatch[3],dateMatch[2]-1,dateMatch[1]);var months=['Jan','Feb','Mär','Apr','Mai','Jun','Jul','Aug','Sep','Okt','Nov','Dez'];event.month=months[date.getMonth()];event.day=date.getDate().toString();event.date=date.toISOString().split('T')[0];}var title=el.querySelector('h1,h2,h3,h4,h5,[class*=&quot;title&quot;]');event.title=title?title.textContent.trim():'Event';var timeMatch=(el.textContent||'').match(/(\d{1,2}):(\d{2})(\s*-\s*\d{1,2}:\d{2})?(\s*Uhr)?/i);event.time=timeMatch?timeMatch[0]:'';var text=el.textContent||'';['Berlin','Hamburg','München','Köln','Frankfurt','Stuttgart','Dresden','Leipzig','Online','Zoom'].forEach(function(loc){if(text.includes(loc))event.location=event.location||loc;});event.location=event.location||'';var desc=el.querySelector('p,[class*=&quot;description&quot;]');event.description=desc?desc.textContent.trim().substring(0,200):'';event.category=text.toLowerCase().includes('workshop')?'Workshop':text.toLowerCase().includes('info')?'Infoabend':'Community Event';event.eventMode=text.toLowerCase().includes('online')||text.toLowerCase().includes('zoom')?'Online':'Offline';event.registrationLink=window.location.href;if(event.title)events.push(event);});if(events.length>0){var json=JSON.stringify(events,null,2);navigator.clipboard.writeText(json).then(function(){alert('✅ '+events.length+' Events kopiert!\n\nJetzt im Newsletter Builder einfügen.');}).catch(function(){prompt('Events kopieren:',json);});}else{alert('❌ Keine Events gefunden.\n\nStellen Sie sicher, dass Sie auf einer Event-Seite sind.');}})();" 
                       class="bookmarklet-link" 
                       onclick="event.preventDefault(); alert('Bitte ziehen Sie diesen Button in Ihre Lesezeichen-Leiste!');">
                    🎯 SwaF Event Scraper
                </a>
                <p style="font-size: 12px; color: #666; margin-top: 10px;">
                    ⚠️ Hinweis: Der Button muss gezogen werden, nicht geklickt!
                </p>
            </div>
            
            <div style="margin: 20px 0;">
                <h3>2. Events kopieren</h3>
                <ol style="margin-left: 20px; line-height: 1.8;">
                    <li>Öffnen Sie <a href="https://portal.startwithafriend.de/events" target="_blank" style="color: var(--primary-color);">portal.startwithafriend.de/events</a></li>
                    <li>Klicken Sie auf das Bookmarklet in Ihrer Lesezeichen-Leiste</li>
                    <li>Die Events werden automatisch in die Zwischenablage kopiert</li>
                </ol>
            </div>
            
            <div class="paste-events-box">
                <h3>3. Events einfügen</h3>
                <p>Fügen Sie die kopierten Events hier ein (Strg+V / Cmd+V):</p>
                <textarea id="pasteEventsArea" class="paste-events-textarea" placeholder="JSON-Daten hier einfügen..."></textarea>
                <button class="primary-btn" onclick="templateBuilder.importPastedEvents()">Events importieren</button>
                <p style="font-size: 12px; color: #666; margin-top: 10px;">
                    💡 Tipp: Sie können mehrmals hintereinander verschiedene Seiten scrapen und einfügen!
                </p>
            </div>
            
            <div class="modal-actions">
                <button class="secondary-btn" id="cancelEventImport">Schließen</button>
            </div>
        </div>
    </div>

    <!-- Copy HTML Modal -->
    <div id="copyHTMLModal" class="modal">
        <div class="modal-content" style="min-width: 700px;">
            <div class="modal-header">
                <h2>HTML für CleverReach</h2>
            </div>
            <div class="copy-html-box">
                <p>Der HTML-Code wurde in die Zwischenablage kopiert! Fügen Sie ihn direkt in CleverReach ein.</p>
                <div class="html-preview" id="htmlPreview"></div>
                <button class="primary-btn" onclick="templateBuilder.copyHTMLAgain()">Erneut kopieren</button>
            </div>
            <div class="modal-actions">
                <button class="primary-btn" id="closeCopyHTML">Schließen</button>
            </div>
        </div>
    </div>

    <!-- Preview Modal -->
    <div id="previewModal" class="modal">
        <div class="modal-content" style="width: 90vw; max-width: 1200px;">
            <div class="modal-header">
                <h2>Template Vorschau</h2>
            </div>
            <div style="height: 600px; overflow-y: auto; border: 1px solid #ddd; border-radius: 4px; background: white;">
                <iframe id="previewFrame" style="width: 100%; height: 100%; border: none;"></iframe>
            </div>
            <div class="modal-actions">
                <button class="primary-btn" id="closePreview">Schließen</button>
            </div>
        </div>
    </div>

    <div id="overlay"></div>

    <script>
        // Module Templates Definition
        const MODULE_TEMPLATES = {
            'preheader': {
                title: 'Preheader',
                html: `<div id="CR-PRHEADER" style="display:none;font-size:1px;line-height:1px;max-height:0px;max-width:0px;opacity:0;overflow:hidden;mso-hide:all;">{{preheaderText}}&zwnj;&nbsp;&zwnj;&nbsp;&zwnj;&nbsp;&zwnj;&nbsp;&zwnj;&nbsp;</div>`,
                fields: [
                    { name: 'preheaderText', label: 'Preheader Text (max. 100 Zeichen)', type: 'text', default: 'Wir freuen uns dich zu sehen.' }
                ]
            },
            'header': {
                title: 'Header (Logo & Onlineversion)',
                html: `
                    <table align="center" border="0" cellpadding="0" cellspacing="0" style="width:640px">
                        <tbody>
                            <tr>
                                <td style="padding: 20px 30px;">
                                    <table align="left" style="width: 280px;">
                                        <tbody>
                                            <tr>
                                                <td align="left" style="padding-top:20px;padding-bottom:0px;">
                                                    <a href="{{logoLink}}">
                                                        <img alt="Start with a Friend" height="36" src="{{logoUrl}}" style="border: 0px; display: block; width: 180px; height: 36px;" width="180">
                                                    </a>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                    <table align="right">
                                        <tbody>
                                            <tr>
                                                <td align="right" style="padding-top:20px;padding-bottom: 0px;">
                                                    <a href="https://newsletter.start-with-a-friend.de/m/[MAILING_ID]/[HASH]" style="color: #009a93; text-decoration: none;">{{onlineVersionText}}</a>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                `,
                fields: [
                    { name: 'logoUrl', label: 'Logo URL', type: 'text', default: 'https://www.start-with-a-friend.de/wp-content/uploads/2023/05/start-with-a-friend-mobile-logo-1-ai-1.svg' },
                    { name: 'logoLink', label: 'Logo Link', type: 'text', default: 'https://www.start-with-a-friend.de/' },
                    { name: 'onlineVersionText', label: 'Online Version Text', type: 'text', default: 'Im Browser ansehen' }
                ]
            },
            'hero-image': {
                title: 'Hero Bild',
                html: `
                    <table align="center" border="0" cellpadding="0" cellspacing="0" style="width:640px">
                        <tbody>
                            <tr>
                                <td style="padding: 0;">
                                    <img src="{{heroImageUrl}}" alt="{{heroImageAlt}}" style="width: 100%; max-width: 640px; height: auto; display: block;">
                                </td>
                            </tr>
                        </tbody>
                    </table>
                `,
                fields: [
                    { name: 'heroImageUrl', label: 'Hero Bild URL', type: 'image', default: 'https://via.placeholder.com/640x360' },
                    { name: 'heroImageAlt', label: 'Bild Alt-Text', type: 'text', default: 'Hero Image' }
                ]
            },
            'greeting': {
                title: 'Begrüßung',
                html: `
                    <table align="center" border="0" cellpadding="0" cellspacing="0" style="width:640px">
                        <tbody>
                            <tr>
                                <td style="padding: 30px;">
                                    <h2 style="color: #009a93; margin: 0 0 15px 0;">{{greetingTitle}}</h2>
                                    <p style="color: #333; line-height: 1.6; margin: 0;">{{greetingText}}</p>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                `,
                fields: [
                    { name: 'greetingTitle', label: 'Begrüßung', type: 'text', default: 'Hallo {FIRSTNAME[std:liebe/r Freund/in]}!' },
                    { name: 'greetingText', label: 'Begrüßungstext', type: 'textarea', default: 'schön, dass du dabei bist! Wir haben wieder spannende Neuigkeiten und Events für dich.' }
                ]
            },
            'text-only': {
                title: 'Nur Text',
                html: `
                    <table align="center" border="0" cellpadding="0" cellspacing="0" style="width:640px">
                        <tbody>
                            <tr>
                                <td style="padding: 20px 30px;">
                                    <h3 style="color: #009a93; margin: 0 0 15px 0;">{{textTitle}}</h3>
                                    <p style="color: #333; line-height: 1.6;">{{textContent}}</p>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                `,
                fields: [
                    { name: 'textTitle', label: 'Überschrift (optional)', type: 'text', default: '' },
                    { name: 'textContent', label: 'Text', type: 'textarea', default: 'Ihr Text hier...' }
                ]
            },
            'image-text': {
                title: 'Bild & Text',
                html: `
                    <table align="center" border="0" cellpadding="0" cellspacing="0" style="width:640px">
                        <tbody>
                            <tr>
                                <td style="padding: 20px 30px;">
                                    <img src="{{imageUrl}}" alt="{{imageAlt}}" style="width: 100%; max-width: 580px; height: auto;">
                                    <h2 style="color: #009a93; margin: 20px 0 10px 0;">{{headline}}</h2>
                                    <p style="color: #333; line-height: 1.6;">{{text}}</p>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                `,
                fields: [
                    { name: 'imageUrl', label: 'Bild URL', type: 'image', default: 'https://via.placeholder.com/580x290' },
                    { name: 'imageAlt', label: 'Bild Alt-Text', type: 'text', default: 'Bild' },
                    { name: 'headline', label: 'Überschrift', type: 'text', default: 'Überschrift' },
                    { name: 'text', label: 'Text', type: 'textarea', default: 'Hier kommt Ihr Text.' }
                ]
            },
            'events': {
                title: 'Events',
                html: `<div class="events-container">{{eventsContent}}</div>`,
                fields: [
                    { name: 'eventsTitle', label: 'Events Überschrift', type: 'text', default: 'Unsere nächsten Events' },
                    { name: 'events', label: 'Events', type: 'dynamic-list', default: [] }
                ]
            },
            'two-columns': {
                title: 'Zwei Spalten',
                html: `
                    <table align="center" border="0" cellpadding="0" cellspacing="0" style="width:640px">
                        <tbody>
                            <tr>
                                <td style="padding: 20px 30px;">
                                    <table>
                                        <tr>
                                            <td style="width: 48%; vertical-align: top;">
                                                <h3 style="color: #009a93;">{{leftTitle}}</h3>
                                                <p>{{leftContent}}</p>
                                            </td>
                                            <td style="width: 4%;"></td>
                                            <td style="width: 48%; vertical-align: top;">
                                                <h3 style="color: #009a93;">{{rightTitle}}</h3>
                                                <p>{{rightContent}}</p>
                                            </td>
                                        </tr>
                                    </table>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                `,
                fields: [
                    { name: 'leftTitle', label: 'Linke Überschrift', type: 'text', default: 'Überschrift Links' },
                    { name: 'leftContent', label: 'Linker Inhalt', type: 'textarea', default: 'Inhalt der linken Spalte' },
                    { name: 'rightTitle', label: 'Rechte Überschrift', type: 'text', default: 'Überschrift Rechts' },
                    { name: 'rightContent', label: 'Rechter Inhalt', type: 'textarea', default: 'Inhalt der rechten Spalte' }
                ]
            },
            'three-columns': {
                title: 'Drei Spalten',
                html: `
                    <table align="center" border="0" cellpadding="0" cellspacing="0" style="width:640px">
                        <tbody>
                            <tr>
                                <td style="padding: 20px 30px;">
                                    <table>
                                        <tr>
                                            <td style="width: 31%; vertical-align: top;">
                                                <h4 style="color: #009a93;">{{col1Title}}</h4>
                                                <p style="font-size: 14px;">{{col1Content}}</p>
                                            </td>
                                            <td style="width: 3.5%;"></td>
                                            <td style="width: 31%; vertical-align: top;">
                                                <h4 style="color: #009a93;">{{col2Title}}</h4>
                                                <p style="font-size: 14px;">{{col2Content}}</p>
                                            </td>
                                            <td style="width: 3.5%;"></td>
                                            <td style="width: 31%; vertical-align: top;">
                                                <h4 style="color: #009a93;">{{col3Title}}</h4>
                                                <p style="font-size: 14px;">{{col3Content}}</p>
                                            </td>
                                        </tr>
                                    </table>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                `,
                fields: [
                    { name: 'col1Title', label: 'Spalte 1 Titel', type: 'text', default: 'Titel 1' },
                    { name: 'col1Content', label: 'Spalte 1 Inhalt', type: 'textarea', default: 'Inhalt 1' },
                    { name: 'col2Title', label: 'Spalte 2 Titel', type: 'text', default: 'Titel 2' },
                    { name: 'col2Content', label: 'Spalte 2 Inhalt', type: 'textarea', default: 'Inhalt 2' },
                    { name: 'col3Title', label: 'Spalte 3 Titel', type: 'text', default: 'Titel 3' },
                    { name: 'col3Content', label: 'Spalte 3 Inhalt', type: 'textarea', default: 'Inhalt 3' }
                ]
            },
            'quote': {
                title: 'Zitat',
                html: `
                    <table align="center" border="0" cellpadding="0" cellspacing="0" style="width:640px">
                        <tbody>
                            <tr>
                                <td style="padding: 30px; background-color: #f8f9fa; border-left: 4px solid #009a93;">
                                    <blockquote style="margin: 0; font-style: italic; color: #555; font-size: 18px; line-height: 1.6;">
                                        "{{quoteText}}"
                                    </blockquote>
                                    <p style="margin-top: 15px; color: #009a93; font-weight: bold;">— {{quoteAuthor}}</p>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                `,
                fields: [
                    { name: 'quoteText', label: 'Zitat', type: 'textarea', default: 'Integration ist keine Einbahnstraße, sondern ein gemeinsamer Weg.' },
                    { name: 'quoteAuthor', label: 'Autor', type: 'text', default: 'Start with a Friend' }
                ]
            },
            'button-center': {
                title: 'Button (zentriert)',
                html: `
                    <table align="center" border="0" cellpadding="0" cellspacing="0" style="width:640px">
                        <tbody>
                            <tr>
                                <td style="padding: 30px; text-align: center;">
                                    <a href="{{buttonLink}}" style="display: inline-block; padding: 14px 32px; background-color: #009a93; color: white; text-decoration: none; border-radius: 6px; font-weight: bold; font-size: 16px;">{{buttonText}}</a>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                `,
                fields: [
                    { name: 'buttonText', label: 'Button Text', type: 'text', default: 'Jetzt mitmachen' },
                    { name: 'buttonLink', label: 'Button Link', type: 'text', default: 'https://www.start-with-a-friend.de/mitmachen/' }
                ]
            },
            'cta-section': {
                title: 'Call-to-Action',
                html: `
                    <table align="center" border="0" cellpadding="0" cellspacing="0" style="width:640px">
                        <tbody>
                            <tr>
                                <td style="padding: 30px; background-color: #f8f9fa; text-align: center;">
                                    <h2 style="color: #009a93; margin-bottom: 15px;">{{ctaTitle}}</h2>
                                    <p style="margin-bottom: 20px;">{{ctaText}}</p>
                                    <a href="{{ctaLink}}" style="display: inline-block; padding: 12px 30px; background-color: #009a93; color: white; text-decoration: none; border-radius: 6px; font-weight: bold;">{{ctaButtonText}}</a>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                `,
                fields: [
                    { name: 'ctaTitle', label: 'Überschrift', type: 'text', default: 'Werde aktiv!' },
                    { name: 'ctaText', label: 'Text', type: 'textarea', default: 'Melde dich jetzt an und werde Teil unserer Community.' },
                    { name: 'ctaButtonText', label: 'Button Text', type: 'text', default: 'Jetzt mitmachen' },
                    { name: 'ctaLink', label: 'Button Link', type: 'text', default: 'https://www.start-with-a-friend.de/mitmachen/' }
                ]
            },
            'social-media': {
                title: 'Social Media',
                html: `
                    <table align="center" border="0" cellpadding="0" cellspacing="0" style="width:640px">
                        <tbody>
                            <tr>
                                <td style="padding: 30px; text-align: center; background-color: #f8f9fa;">
                                    <h3 style="color: #009a93; margin-bottom: 20px;">{{socialTitle}}</h3>
                                    <table align="center" style="display: inline-table;">
                                        <tr>
                                            <td style="padding: 0 10px;">
                                                <a href="{{facebookLink}}">
                                                    <img src="https://cdn-icons-png.flaticon.com/512/124/124010.png" alt="Facebook" width="32" height="32">
                                                </a>
                                            </td>
                                            <td style="padding: 0 10px;">
                                                <a href="{{instagramLink}}">
                                                    <img src="https://cdn-icons-png.flaticon.com/512/2111/2111463.png" alt="Instagram" width="32" height="32">
                                                </a>
                                            </td>
                                            <td style="padding: 0 10px;">
                                                <a href="{{linkedinLink}}">
                                                    <img src="https://cdn-icons-png.flaticon.com/512/174/174857.png" alt="LinkedIn" width="32" height="32">
                                                </a>
                                            </td>
                                        </tr>
                                    </table>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                `,
                fields: [
                    { name: 'socialTitle', label: 'Überschrift', type: 'text', default: 'Folge uns auf Social Media' },
                    { name: 'facebookLink', label: 'Facebook Link', type: 'text', default: 'https://www.facebook.com/startwithafriend' },
                    { name: 'instagramLink', label: 'Instagram Link', type: 'text', default: 'https://www.instagram.com/teamswaf' },
                    { name: 'linkedinLink', label: 'LinkedIn Link', type: 'text', default: 'https://www.linkedin.com/company/start-with-a-friend' }
                ]
            },
            'divider': {
                title: 'Trennlinie',
                html: `
                    <table align="center" border="0" cellpadding="0" cellspacing="0" style="width:640px">
                        <tbody>
                            <tr>
                                <td style="padding: 20px 30px;">
                                    <hr style="border: none; border-top: {{dividerStyle}} {{dividerWidth}}px {{dividerColor}}; margin: 0;">
                                </td>
                            </tr>
                        </tbody>
                    </table>
                `,
                fields: [
                    { name: 'dividerStyle', label: 'Stil', type: 'select', options: ['solid', 'dashed', 'dotted'], default: 'solid' },
                    { name: 'dividerWidth', label: 'Breite (px)', type: 'number', default: '1' },
                    { name: 'dividerColor', label: 'Farbe', type: 'text', default: '#e0e0e0' }
                ]
            },
            'contact-person': {
                title: 'Ansprechpartner',
                html: `
                    <table align="center" border="0" cellpadding="0" cellspacing="0" style="width:640px">
                        <tbody>
                            <tr>
                                <td style="padding: 20px 30px;">
                                    <h3 style="color: #009a93;">{{contactTitle}}</h3>
                                    <table>
                                        <tr>
                                            <td style="width: 120px; vertical-align: top;">
                                                <img src="{{contactImageUrl}}" alt="{{contactImageAlt}}" style="width: 100px; height: 100px; border-radius: 50%;">
                                            </td>
                                            <td style="padding-left: 20px; vertical-align: top;">
                                                <p style="font-weight: bold; margin: 0;">{{contactName}}</p>
                                                <p style="margin: 5px 0;">{{contactPosition}}</p>
                                                <p style="margin: 5px 0;">{{contactEmail}}</p>
                                                <p style="margin: 5px 0;">{{contactPhone}}</p>
                                            </td>
                                        </tr>
                                    </table>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                `,
                fields: [
                    { name: 'contactTitle', label: 'Überschrift', type: 'text', default: 'Dein Ansprechpartner' },
                    { name: 'contactImageUrl', label: 'Bild URL', type: 'image', default: 'https://via.placeholder.com/120x120' },
                    { name: 'contactImageAlt', label: 'Bild Alt-Text', type: 'text', default: 'Profilbild' },
                    { name: 'contactName', label: 'Name', type: 'text', default: 'Max Mustermann' },
                    { name: 'contactPosition', label: 'Position', type: 'text', default: 'Standortleitung Berlin' },
                    { name: 'contactEmail', label: 'E-Mail', type: 'text', default: 'berlin@start-with-a-friend.de' },
                    { name: 'contactPhone', label: 'Telefon', type: 'text', default: '+49 30 5557 7855' }
                ]
            },
            'partner-news': {
                title: 'Partner News',
                html: `
                    <table align="center" border="0" cellpadding="0" cellspacing="0" style="width:640px">
                        <tbody>
                            <tr>
                                <td style="padding: 20px 30px; background-color: #f8f9fa;">
                                    <h3 style="color: #009a93;">{{partnerTitle}}</h3>
                                    <img src="{{partnerLogo}}" alt="{{partnerAlt}}" style="max-width: 200px; margin: 15px 0;">
                                    <p>{{partnerContent}}</p>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                `,
                fields: [
                    { name: 'partnerTitle', label: 'Titel', type: 'text', default: 'News von unseren Partnern' },
                    { name: 'partnerLogo', label: 'Partner Logo URL', type: 'image', default: 'https://via.placeholder.com/200x80' },
                    { name: 'partnerAlt', label: 'Logo Alt-Text', type: 'text', default: 'Partner Logo' },
                    { name: 'partnerContent', label: 'Inhalt', type: 'textarea', default: 'Informationen über unsere Partner.' }
                ]
            },
            'footer-imprint': {
                title: 'Footer/Impressum',
                html: `
                    <table align="center" border="0" cellpadding="0" cellspacing="0" style="width:640px">
                        <tbody>
                            <tr>
                                <td style="padding: 20px 30px; text-align: center; font-size: 12px; color: #666;">
                                    <p>Start with a Friend e.V.</p>
                                    <p>Wiclefstraße 17, 10551 Berlin</p>
                                    <p>Tel: +49 30 5557 7855</p>
                                    <p>E-Mail: info@start-with-a-friend.de</p>
                                    <p style="margin-top: 10px;">
                                        <a href="https://www.start-with-a-friend.de" style="color: #009a93;">Website</a> |
                                        <a href="https://www.facebook.com/startwithafriend" style="color: #009a93;">Facebook</a> |
                                        <a href="https://www.instagram.com/teamswaf" style="color: #009a93;">Instagram</a>
                                    </p>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                `,
                fields: []
            },
            'unsubscribe': {
                title: 'Abmelde-Link',
                html: `
                    <table align="center" border="0" cellpadding="0" cellspacing="0" style="width:640px">
                        <tbody>
                            <tr>
                                <td style="padding: 20px 30px; text-align: center; color: #666; font-size: 12px;">
                                    <p>{{unsubscribeText}} <a href="<!--#unsubscribe#-->" style="color: #666;">{{unsubscribeLinkText}}</a></p>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                `,
                fields: [
                    { name: 'unsubscribeText', label: 'Abmelde-Text', type: 'text', default: 'Wenn Sie diese E-Mail nicht mehr empfangen möchten, können Sie diese' },
                    { name: 'unsubscribeLinkText', label: 'Link Text', type: 'text', default: 'hier kostenlos abbestellen' }
                ]
            }
        };

        // Template Builder Class
        class TemplateBuilder {
            constructor() {
                this.modules = [];
                this.moduleCounter = 0;
                this.currentEditingModule = null;
                this.currentHTML = '';
                this.init();
            }

            init() {
                this.setupEventListeners();
                this.setupDragAndDrop();
                this.loadAutoSave();
            }

            setupEventListeners() {
                // Header buttons
                document.getElementById('newTemplateBtn').addEventListener('click', () => this.newTemplate());
                document.getElementById('saveTemplateBtn').addEventListener('click', () => this.saveTemplate());
                document.getElementById('loadTemplateBtn').addEventListener('click', () => this.loadTemplate());
                document.getElementById('exportTemplateBtn').addEventListener('click', () => this.exportJSON());
                document.getElementById('importTemplateBtn').addEventListener('click', () => this.importJSON());
                document.getElementById('previewBtn').addEventListener('click', () => this.showPreview());
                document.getElementById('copyHTMLBtn').addEventListener('click', () => this.copyHTML());
                
                // Editor actions
                document.getElementById('clearTemplateBtn').addEventListener('click', () => this.clearTemplate());
                document.getElementById('generateHTMLBtn').addEventListener('click', () => this.generateHTML());
                
                // Modal actions
                document.getElementById('cancelModuleEdit').addEventListener('click', () => this.closeModuleEditor());
                document.getElementById('saveModuleEdit').addEventListener('click', () => this.saveModuleEdit());
                document.getElementById('closePreview').addEventListener('click', () => this.closePreview());
                document.getElementById('cancelEventImport').addEventListener('click', () => this.closeEventImport());
                document.getElementById('closeCopyHTML').addEventListener('click', () => this.closeCopyHTML());
                
                // Module editor tabs
                document.querySelectorAll('.module-editor-tab').forEach(tab => {
                    tab.addEventListener('click', (e) => this.switchTab(e.target.dataset.tab));
                });
                
                // Overlay
                document.getElementById('overlay').addEventListener('click', () => {
                    this.closeModuleEditor();
                    this.closePreview();
                    this.closeEventImport();
                    this.closeCopyHTML();
                });
                
                // Auto-save on changes
                document.getElementById('templateTitle').addEventListener('input', () => this.autoSave());
            }

            setupDragAndDrop() {
                const sidebar = document.querySelector('.sidebar');
                const previewArea = document.querySelector('.preview-content');
                
                // Sidebar modules
                sidebar.querySelectorAll('.module').forEach(module => {
                    module.addEventListener('dragstart', (e) => {
                        e.dataTransfer.effectAllowed = 'copy';
                        e.dataTransfer.setData('moduleType', module.dataset.moduleType);
                        e.dataTransfer.setData('action', 'add');
                    });
                });
                
                // Preview area
                previewArea.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    e.dataTransfer.dropEffect = 'copy';
                    previewArea.classList.add('drag-over');
                });
                
                previewArea.addEventListener('dragleave', () => {
                    previewArea.classList.remove('drag-over');
                });
                
                previewArea.addEventListener('drop', (e) => {
                    e.preventDefault();
                    previewArea.classList.remove('drag-over');
                    
                    const action = e.dataTransfer.getData('action');
                    
                    if (action === 'add') {
                        const moduleType = e.dataTransfer.getData('moduleType');
                        this.addModule(moduleType);
                    }
                });
            }

            addModule(type) {
                const template = MODULE_TEMPLATES[type];
                if (!template) return;
                
                const moduleId = `module-${++this.moduleCounter}`;
                const moduleData = {
                    id: moduleId,
                    type: type,
                    fields: {}
                };
                
                // Set default values
                template.fields.forEach(field => {
                    moduleData.fields[field.name] = field.default;
                });
                
                this.modules.push(moduleData);
                this.renderModule(moduleData);
                this.autoSave();
                this.showNotification('Modul hinzugefügt');
            }

            renderModule(moduleData) {
                const previewContent = document.getElementById('previewContent');
                
                // Clear placeholder if this is the first module
                if (this.modules.length === 1) {
                    previewContent.innerHTML = '';
                }
                
                const moduleElement = document.createElement('div');
                moduleElement.className = 'template-module';
                moduleElement.id = moduleData.id;
                moduleElement.draggable = true;
                
                const template = MODULE_TEMPLATES[moduleData.type];
                
                moduleElement.innerHTML = `
                    <div class="module-header">
                        <div class="module-header-left">
                            <span class="module-drag-handle"></span>
                            <span class="module-title">${template.title}</span>
                        </div>
                        <div class="module-actions">
                            <button class="move-up" onclick="templateBuilder.moveModuleUp('${moduleData.id}')" title="Nach oben">↑</button>
                            <button class="move-down" onclick="templateBuilder.moveModuleDown('${moduleData.id}')" title="Nach unten">↓</button>
                            <button class="edit-module" onclick="templateBuilder.editModule('${moduleData.id}')">✎ Bearbeiten</button>
                            <button class="duplicate-module" onclick="templateBuilder.duplicateModule('${moduleData.id}')">⎘ Duplizieren</button>
                            <button class="delete-module" onclick="templateBuilder.deleteModule('${moduleData.id}')">✕ Löschen</button>
                        </div>
                    </div>
                    <div class="module-content">
                        ${this.renderModuleContent(moduleData)}
                    </div>
                `;
                
                previewContent.appendChild(moduleElement);
                this.setupModuleDragAndDrop(moduleElement);
            }

            moveModuleUp(moduleId) {
                const index = this.modules.findIndex(m => m.id === moduleId);
                if (index > 0) {
                    // Swap in array
                    [this.modules[index], this.modules[index - 1]] = [this.modules[index - 1], this.modules[index]];
                    
                    // Swap in DOM
                    const element = document.getElementById(moduleId);
                    const prevElement = element.previousElementSibling;
                    if (prevElement) {
                        element.parentNode.insertBefore(element, prevElement);
                    }
                    
                    this.autoSave();
                }
            }

            moveModuleDown(moduleId) {
                const index = this.modules.findIndex(m => m.id === moduleId);
                if (index < this.modules.length - 1) {
                    // Swap in array
                    [this.modules[index], this.modules[index + 1]] = [this.modules[index + 1], this.modules[index]];
                    
                    // Swap in DOM
                    const element = document.getElementById(moduleId);
                    const nextElement = element.nextElementSibling;
                    if (nextElement) {
                        element.parentNode.insertBefore(nextElement, element);
                    }
                    
                    this.autoSave();
                }
            }

            renderModuleContent(moduleData) {
                const template = MODULE_TEMPLATES[moduleData.type];
                let html = template.html;
                
                // Special handling for events module
                if (moduleData.type === 'events') {
                    const events = moduleData.fields.events || [];
                    let eventsHtml = '<h2 style="color: #009a93; text-align: center; margin: 20px 0;">' + 
                                     (moduleData.fields.eventsTitle || 'Unsere nächsten Events') + '</h2>';
                    
                    if (events.length === 0) {
                        eventsHtml += '<p style="text-align: center; color: #666;">Keine Events vorhanden. Klicken Sie auf "Bearbeiten" um Events hinzuzufügen.</p>';
                    } else {
                        events.forEach(event => {
                            eventsHtml += this.renderEventHTML(event);
                        });
                    }
                    
                    html = html.replace('{{eventsContent}}', eventsHtml);
                } else {
                    // Replace placeholders with field values
                    template.fields.forEach(field => {
                        const value = moduleData.fields[field.name] || field.default;
                        const regex = new RegExp(`{{${field.name}}}`, 'g');
                        html = html.replace(regex, value);
                    });
                }
                
                return html;
            }

            renderEventHTML(event) {
                return `
                    <table align="center" border="0" cellpadding="0" cellspacing="0" style="width:640px">
                        <tbody>
                            <tr>
                                <td style="padding: 15px 30px;">
                                    <table style="width: 100%; border: 1px solid #e0e0e0; border-radius: 8px;">
                                        <tr>
                                            <td style="padding: 20px;">
                                                <table>
                                                    <tr>
                                                        <td style="width: 60px; vertical-align: top;">
                                                            <div style="background: #009a93; color: white; padding: 8px; border-radius: 4px; text-align: center;">
                                                                <div style="font-size: 11px;">${event.month || 'TBD'}</div>
                                                                <div style="font-size: 20px; font-weight: bold;">${event.day || '?'}</div>
                                                            </div>
                                                        </td>
                                                        <td style="padding-left: 20px;">
                                                            <h3 style="color: #009a93; margin: 0 0 10px 0;">${event.title}</h3>
                                                            <p style="margin: 5px 0;"><strong>Zeit:</strong> ${event.time}</p>
                                                            <p style="margin: 5px 0;"><strong>Ort:</strong> ${event.location}</p>
                                                            <p style="margin: 10px 0;">${event.description}</p>
                                                            ${event.registrationLink ? `<a href="${event.registrationLink}" style="color: #009a93;">Jetzt anmelden →</a>` : ''}
                                                        </td>
                                                    </tr>
                                                </table>
                                            </td>
                                        </tr>
                                    </table>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                `;
            }

            setupModuleDragAndDrop(moduleElement) {
                moduleElement.addEventListener('dragstart', (e) => {
                    e.dataTransfer.effectAllowed = 'move';
                    e.dataTransfer.setData('moduleId', moduleElement.id);
                    e.dataTransfer.setData('action', 'move');
                    moduleElement.classList.add('dragging');
                });
                
                moduleElement.addEventListener('dragend', () => {
                    moduleElement.classList.remove('dragging');
                });
                
                moduleElement.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    const draggingElement = document.querySelector('.dragging');
                    if (draggingElement && draggingElement !== moduleElement) {
                        const rect = moduleElement.getBoundingClientRect();
                        const y = e.clientY - rect.top;
                        
                        if (y < rect.height / 2) {
                            moduleElement.style.borderTop = '2px solid #009a93';
                            moduleElement.style.borderBottom = '';
                        } else {
                            moduleElement.style.borderBottom = '2px solid #009a93';
                            moduleElement.style.borderTop = '';
                        }
                    }
                });
                
                moduleElement.addEventListener('dragleave', () => {
                    moduleElement.style.borderTop = '';
                    moduleElement.style.borderBottom = '';
                });
                
                moduleElement.addEventListener('drop', (e) => {
                    e.preventDefault();
                    moduleElement.style.borderTop = '';
                    moduleElement.style.borderBottom = '';
                    
                    const action = e.dataTransfer.getData('action');
                    
                    if (action === 'move') {
                        const draggedId = e.dataTransfer.getData('moduleId');
                        const draggedElement = document.getElementById(draggedId);
                        
                        if (draggedElement && draggedElement !== moduleElement) {
                            const rect = moduleElement.getBoundingClientRect();
                            const y = e.clientY - rect.top;
                            
                            if (y < rect.height / 2) {
                                moduleElement.parentNode.insertBefore(draggedElement, moduleElement);
                            } else {
                                moduleElement.parentNode.insertBefore(draggedElement, moduleElement.nextSibling);
                            }
                            
                            this.updateModulesOrder();
                        }
                    }
                });
            }

            updateModulesOrder() {
                const moduleElements = document.querySelectorAll('.template-module');
                const newOrder = [];
                
                moduleElements.forEach(element => {
                    const module = this.modules.find(m => m.id === element.id);
                    if (module) {
                        newOrder.push(module);
                    }
                });
                
                this.modules = newOrder;
                this.autoSave();
            }

            editModule(moduleId) {
                const module = this.modules.find(m => m.id === moduleId);
                if (!module) return;
                
                this.currentEditingModule = module;
                const template = MODULE_TEMPLATES[module.type];
                
                document.getElementById('moduleEditorTitle').textContent = `${template.title} bearbeiten`;
                
                // Build editor content
                let editorHTML = '<div id="contentTab" class="tab-content">';
                
                // Special handling for events module
                if (module.type === 'events') {
                    editorHTML += this.buildEventsEditor(module);
                } else {
                    template.fields.forEach(field => {
                        editorHTML += this.buildFieldEditor(field, module.fields[field.name]);
                    });
                }
                
                editorHTML += '</div>';
                editorHTML += '<div id="settingsTab" class="tab-content" style="display: none;">';
                editorHTML += '<p>Hier können Sie erweiterte Einstellungen vornehmen.</p>';
                editorHTML += '</div>';
                
                document.getElementById('moduleEditorContent').innerHTML = editorHTML;
                
                // Show modal
                document.getElementById('moduleEditorModal').style.display = 'block';
                document.getElementById('overlay').style.display = 'block';
                
                // Setup image upload buttons
                this.setupImageUploads();
            }

            buildEventsEditor(module) {
                let html = '<div class="field-group">';
                html += '<label for="eventsTitle">Events Überschrift</label>';
                html += `<input type="text" id="eventsTitle" name="eventsTitle" value="${module.fields.eventsTitle || 'Unsere nächsten Events'}">`;
                html += '</div>';
                
                html += '<div class="field-group">';
                html += '<label>Events</label>';
                html += '<button class="primary-btn" onclick="templateBuilder.showEventImport()">📥 Events importieren</button>';
                html += '<div class="dynamic-items-list" style="margin-top: 15px;">';
                
                const events = module.fields.events || [];
                events.forEach((event, index) => {
                    html += this.buildEventCard(event, index);
                });
                
                if (events.length === 0) {
                    html += '<p style="color: #666;">Keine Events vorhanden. Nutzen Sie den Import-Button oder fügen Sie manuell Events hinzu.</p>';
                }
                
                html += '</div>';
                html += '<button class="secondary-btn" onclick="templateBuilder.addManualEvent()" style="margin-top: 10px;">+ Event manuell hinzufügen</button>';
                html += '</div>';
                
                return html;
            }

            showEventImport() {
                document.getElementById('eventImportModal').style.display = 'block';
                document.getElementById('overlay').style.display = 'block';
            }

            closeEventImport() {
                document.getElementById('eventImportModal').style.display = 'none';
                document.getElementById('overlay').style.display = 'none';
            }

            importPastedEvents() {
                const textarea = document.getElementById('pasteEventsArea');
                const jsonText = textarea.value.trim();
                
                if (!jsonText) {
                    this.showNotification('Bitte fügen Sie die kopierten Events ein.', true);
                    return;
                }
                
                try {
                    const events = JSON.parse(jsonText);
                    
                    if (!Array.isArray(events)) {
                        throw new Error('Die Daten sind kein gültiges Event-Array');
                    }
                    
                    if (events.length === 0) {
                        this.showNotification('Keine Events in den Daten gefunden', true);
                        return;
                    }
                    
                    // Add events to current module
                    if (this.currentEditingModule) {
                        if (!this.currentEditingModule.fields.events) {
                            this.currentEditingModule.fields.events = [];
                        }
                        
                        // Process events for CleverReach personalization
                        events.forEach(event => {
                            if (event.title) {
                                event.title = event.title.replace(/\{NAME\}/g, '{FIRSTNAME[std:Hi]}');
                            }
                            if (event.description) {
                                event.description = event.description.replace(/\{NAME\}/g, '{FIRSTNAME[std:Hi]}');
                            }
                        });
                        
                        // Ask if existing events should be kept
                        if (this.currentEditingModule.fields.events.length > 0) {
                            if (confirm(`Es sind bereits ${this.currentEditingModule.fields.events.length} Events vorhanden. Möchten Sie die neuen Events hinzufügen (OK) oder ersetzen (Abbrechen)?`)) {
                                this.currentEditingModule.fields.events.push(...events);
                            } else {
                                this.currentEditingModule.fields.events = events;
                            }
                        } else {
                            this.currentEditingModule.fields.events = events;
                        }
                        
                        // Clear textarea
                        textarea.value = '';
                        
                        // Refresh editor
                        this.editModule(this.currentEditingModule.id);
                        
                        this.showNotification(`${events.length} Events erfolgreich importiert!`, false, 'success');
                    }
                    
                } catch (error) {
                    console.error('Fehler beim Parsen der Events:', error);
                    this.showNotification('Fehler: Die eingefügten Daten sind nicht im richtigen Format', true);
                }
            }

            buildEventCard(event, index) {
                // CleverReach Personalisierung
                const personalizedTitle = event.title ? event.title.replace(/\{NAME\}/g, '{FIRSTNAME[std:Hi]}') : event.title;
                const personalizedDescription = event.description ? event.description.replace(/\{NAME\}/g, '{FIRSTNAME[std:Hi]}') : event.description;
                
                return `
                    <div class="event-card" data-index="${index}">
                        <div class="event-card-header">
                            <div style="display: flex; align-items: start; gap: 15px; flex: 1;">
                                <div class="event-date-box">
                                    <div class="event-date-month">${event.month || 'TBD'}</div>
                                    <div class="event-date-day">${event.day || '?'}</div>
                                </div>
                                <div style="flex: 1;">
                                    <input type="text" value="${personalizedTitle}" onchange="templateBuilder.updateEvent(${index}, 'title', this.value)" style="width: 100%; margin-bottom: 5px;" placeholder="Event Titel">
                                    <input type="date" value="${event.date || ''}" onchange="templateBuilder.updateEvent(${index}, 'date', this.value)" style="width: 100%; margin-bottom: 5px;">
                                    <input type="text" value="${event.time}" onchange="templateBuilder.updateEvent(${index}, 'time', this.value)" style="width: 100%; margin-bottom: 5px;" placeholder="Uhrzeit">
                                    <input type="text" value="${event.location}" onchange="templateBuilder.updateEvent(${index}, 'location', this.value)" style="width: 100%; margin-bottom: 5px;" placeholder="Ort">
                                    <textarea onchange="templateBuilder.updateEvent(${index}, 'description', this.value)" style="width: 100%; margin-bottom: 5px;" placeholder="Beschreibung">${personalizedDescription}</textarea>
                                    <input type="text" value="${event.registrationLink || ''}" onchange="templateBuilder.updateEvent(${index}, 'registrationLink', this.value)" style="width: 100%;" placeholder="Anmelde-Link (optional)">
                                    <div style="margin-top: 5px; font-size: 11px; color: #666;">
                                        Tipp: Verwenden Sie {FIRSTNAME[std:Hi]} für personalisierte Anrede in CleverReach
                                    </div>
                                </div>
                            </div>
                            <div class="event-badges">
                                ${event.category ? `<span class="badge badge-category">${event.category}</span>` : ''}
                                ${event.eventMode ? `<span class="badge badge-mode">${event.eventMode}</span>` : ''}
                            </div>
                        </div>
                        <div style="margin-top: 10px; text-align: right;">
                            <button class="delete-module" onclick="templateBuilder.removeEvent(${index})">Event löschen</button>
                        </div>
                    </div>
                `;
            }

            buildFieldEditor(field, value) {
                let html = '<div class="field-group">';
                html += `<label for="${field.name}">${field.label}</label>`;
                
                switch (field.type) {
                    case 'textarea':
                        html += `<textarea id="${field.name}" name="${field.name}">${value || field.default}</textarea>`;
                        break;
                    case 'image':
                        html += `<input type="text" id="${field.name}" name="${field.name}" value="${value || field.default}">`;
                        html += `<button class="image-upload-btn" data-field="${field.name}">Bild hochladen</button>`;
                        if (value) {
                            html += `<div class="image-preview"><img src="${value}" alt="Vorschau"></div>`;
                        }
                        break;
                    case 'select':
                        html += `<select id="${field.name}" name="${field.name}">`;
                        field.options.forEach(option => {
                            html += `<option value="${option}" ${(value || field.default) === option ? 'selected' : ''}>${option}</option>`;
                        });
                        html += '</select>';
                        break;
                    case 'number':
                        html += `<input type="number" id="${field.name}" name="${field.name}" value="${value || field.default}">`;
                        break;
                    default:
                        html += `<input type="text" id="${field.name}" name="${field.name}" value="${value || field.default}">`;
                }
                
                html += '</div>';
                return html;
            }

            setupImageUploads() {
                document.querySelectorAll('.image-upload-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const fieldName = e.target.dataset.field;
                        this.uploadImage(fieldName);
                    });
                });
            }

            uploadImage(fieldName) {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = 'image/*';
                
                input.addEventListener('change', (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            const dataUrl = e.target.result;
                            document.getElementById(fieldName).value = dataUrl;
                            
                            // Update preview
                            let preview = document.querySelector(`#${fieldName}`).parentElement.querySelector('.image-preview');
                            if (!preview) {
                                preview = document.createElement('div');
                                preview.className = 'image-preview';
                                document.querySelector(`#${fieldName}`).parentElement.appendChild(preview);
                            }
                            preview.innerHTML = `<img src="${dataUrl}" alt="Vorschau">`;
                        };
                        reader.readAsDataURL(file);
                    }
                });
                
                input.click();
            }

            addManualEvent() {
                if (!this.currentEditingModule) return;
                
                const today = new Date();
                const months = ['Jan', 'Feb', 'Mär', 'Apr', 'Mai', 'Jun', 'Jul', 'Aug', 'Sep', 'Okt', 'Nov', 'Dez'];
                
                const newEvent = {
                    title: 'Neues Event - {FIRSTNAME[std:Hi]}, sei dabei!',
                    month: months[today.getMonth()],
                    day: today.getDate().toString(),
                    date: today.toISOString().split('T')[0],
                    time: '18:00 - 20:00 Uhr',
                    location: 'Berlin',
                    description: 'Beschreibung des Events hier eingeben...',
                    category: 'Community Event',
                    eventMode: 'Offline',
                    registrationLink: 'https://portal.startwithafriend.de/events'
                };
                
                if (!this.currentEditingModule.fields.events) {
                    this.currentEditingModule.fields.events = [];
                }
                
                this.currentEditingModule.fields.events.push(newEvent);
                
                // Refresh editor
                this.editModule(this.currentEditingModule.id);
            }

            updateEvent(index, field, value) {
                if (this.currentEditingModule && this.currentEditingModule.fields.events) {
                    this.currentEditingModule.fields.events[index][field] = value;
                    
                    // Update date display if date field is changed
                    if (field === 'date' && value) {
                        const date = new Date(value);
                        const months = ['Jan', 'Feb', 'Mär', 'Apr', 'Mai', 'Jun', 'Jul', 'Aug', 'Sep', 'Okt', 'Nov', 'Dez'];
                        this.currentEditingModule.fields.events[index].month = months[date.getMonth()];
                        this.currentEditingModule.fields.events[index].day = date.getDate().toString();
                        
                        // Update the display immediately
                        const eventCard = document.querySelector(`.event-card[data-index="${index}"]`);
                        if (eventCard) {
                            const monthElement = eventCard.querySelector('.event-date-month');
                            const dayElement = eventCard.querySelector('.event-date-day');
                            if (monthElement) monthElement.textContent = months[date.getMonth()];
                            if (dayElement) dayElement.textContent = date.getDate().toString();
                        }
                    }
                }
            }

            removeEvent(index) {
                if (this.currentEditingModule && this.currentEditingModule.fields.events) {
                    this.currentEditingModule.fields.events.splice(index, 1);
                    
                    // Refresh editor
                    this.editModule(this.currentEditingModule.id);
                }
            }

            switchTab(tabName) {
                document.querySelectorAll('.module-editor-tab').forEach(tab => {
                    tab.classList.remove('active');
                });
                document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
                
                document.getElementById('contentTab').style.display = tabName === 'content' ? 'block' : 'none';
                document.getElementById('settingsTab').style.display = tabName === 'settings' ? 'block' : 'none';
            }

            saveModuleEdit() {
                if (!this.currentEditingModule) return;
                
                const template = MODULE_TEMPLATES[this.currentEditingModule.type];
                
                // Save regular fields
                template.fields.forEach(field => {
                    if (field.type !== 'dynamic-list') {
                        const input = document.getElementById(field.name);
                        if (input) {
                            this.currentEditingModule.fields[field.name] = input.value;
                        }
                    }
                });
                
                // Update module display
                const moduleElement = document.getElementById(this.currentEditingModule.id);
                if (moduleElement) {
                    const contentElement = moduleElement.querySelector('.module-content');
                    contentElement.innerHTML = this.renderModuleContent(this.currentEditingModule);
                }
                
                this.closeModuleEditor();
                this.autoSave();
                this.showNotification('Modul aktualisiert');
            }

            closeModuleEditor() {
                document.getElementById('moduleEditorModal').style.display = 'none';
                document.getElementById('overlay').style.display = 'none';
                this.currentEditingModule = null;
            }

            duplicateModule(moduleId) {
                const module = this.modules.find(m => m.id === moduleId);
                if (!module) return;
                
                const newModule = JSON.parse(JSON.stringify(module));
                newModule.id = `module-${++this.moduleCounter}`;
                
                const index = this.modules.indexOf(module);
                this.modules.splice(index + 1, 0, newModule);
                
                const moduleElement = document.getElementById(moduleId);
                const newElement = moduleElement.cloneNode(true);
                newElement.id = newModule.id;
                
                // Update event handlers
                newElement.querySelector('.edit-module').setAttribute('onclick', `templateBuilder.editModule('${newModule.id}')`);
                newElement.querySelector('.duplicate-module').setAttribute('onclick', `templateBuilder.duplicateModule('${newModule.id}')`);
                newElement.querySelector('.delete-module').setAttribute('onclick', `templateBuilder.deleteModule('${newModule.id}')`);
                newElement.querySelector('.move-up').setAttribute('onclick', `templateBuilder.moveModuleUp('${newModule.id}')`);
                newElement.querySelector('.move-down').setAttribute('onclick', `templateBuilder.moveModuleDown('${newModule.id}')`);
                
                moduleElement.parentNode.insertBefore(newElement, moduleElement.nextSibling);
                this.setupModuleDragAndDrop(newElement);
                
                this.autoSave();
                this.showNotification('Modul dupliziert');
            }

            deleteModule(moduleId) {
                if (!confirm('Möchten Sie dieses Modul wirklich löschen?')) return;
                
                const index = this.modules.findIndex(m => m.id === moduleId);
                if (index > -1) {
                    this.modules.splice(index, 1);
                    document.getElementById(moduleId).remove();
                    
                    if (this.modules.length === 0) {
                        document.getElementById('previewContent').innerHTML = `
                            <div style="padding: 40px; text-align: center; color: #999;">
                                <p>Ziehen Sie Module aus der Seitenleiste hierher, um Ihr Template zu erstellen.</p>
                            </div>
                        `;
                    }
                    
                    this.autoSave();
                    this.showNotification('Modul gelöscht');
                }
            }

            newTemplate() {
                if (this.modules.length > 0) {
                    if (!confirm('Alle nicht gespeicherten Änderungen gehen verloren. Fortfahren?')) {
                        return;
                    }
                }
                
                this.modules = [];
                this.moduleCounter = 0;
                document.getElementById('templateTitle').value = '';
                document.getElementById('previewContent').innerHTML = `
                    <div style="padding: 40px; text-align: center; color: #999;">
                        <p>Ziehen Sie Module aus der Seitenleiste hierher, um Ihr Template zu erstellen.</p>
                    </div>
                `;
                
                localStorage.removeItem('swafTemplateAutoSave');
                this.showNotification('Neues Template erstellt');
            }

            clearTemplate() {
                if (confirm('Möchten Sie wirklich alle Module entfernen?')) {
                    this.modules = [];
                    document.getElementById('previewContent').innerHTML = `
                        <div style="padding: 40px; text-align: center; color: #999;">
                            <p>Ziehen Sie Module aus der Seitenleiste hierher, um Ihr Template zu erstellen.</p>
                        </div>
                    `;
                    this.autoSave();
                    this.showNotification('Template geleert');
                }
            }

            saveTemplate() {
                const templateName = document.getElementById('templateTitle').value || 'Unbenanntes Template';
                const templateData = {
                    name: templateName,
                    modules: this.modules,
                    savedAt: new Date().toISOString()
                };
                
                // Get existing templates
                const templates = JSON.parse(localStorage.getItem('swafTemplates') || '[]');
                
                // Check if template with same name exists
                const existingIndex = templates.findIndex(t => t.name === templateName);
                
                if (existingIndex > -1) {
                    if (confirm('Ein Template mit diesem Namen existiert bereits. Überschreiben?')) {
                        templates[existingIndex] = templateData;
                    } else {
                        return;
                    }
                } else {
                    templates.push(templateData);
                }
                
                localStorage.setItem('swafTemplates', JSON.stringify(templates));
                this.showNotification('Template gespeichert');
            }

            loadTemplate() {
                const templates = JSON.parse(localStorage.getItem('swafTemplates') || '[]');
                
                if (templates.length === 0) {
                    this.showNotification('Keine gespeicherten Templates vorhanden', true);
                    return;
                }
                
                // Create a simple selection dialog
                const templateList = templates.map((t, i) => `${i + 1}. ${t.name} (${new Date(t.savedAt).toLocaleDateString()})`).join('\n');
                const selection = prompt(`Wählen Sie ein Template (Nummer eingeben):\n\n${templateList}`);
                
                if (selection) {
                    const index = parseInt(selection) - 1;
                    if (templates[index]) {
                        this.loadTemplateData(templates[index]);
                    }
                }
            }

            loadTemplateData(templateData) {
                this.modules = templateData.modules;
                document.getElementById('templateTitle').value = templateData.name;
                
                // Clear and rebuild preview
                document.getElementById('previewContent').innerHTML = '';
                this.modules.forEach(module => {
                    this.renderModule(module);
                });
                
                this.showNotification('Template geladen');
            }

            exportJSON() {
                const templateData = {
                    name: document.getElementById('templateTitle').value || 'template',
                    modules: this.modules,
                    exportedAt: new Date().toISOString(),
                    version: '1.0'
                };
                
                const dataStr = JSON.stringify(templateData, null, 2);
                const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
                
                const exportLink = document.createElement('a');
                exportLink.setAttribute('href', dataUri);
                exportLink.setAttribute('download', `${templateData.name.replace(/\s+/g, '_')}.json`);
                exportLink.click();
                
                this.showNotification('Template als JSON exportiert');
            }

            importJSON() {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = '.json';
                
                input.addEventListener('change', (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            try {
                                const templateData = JSON.parse(e.target.result);
                                this.loadTemplateData(templateData);
                            } catch (error) {
                                this.showNotification('Fehler beim Importieren der Datei', true);
                            }
                        };
                        reader.readAsText(file);
                    }
                });
                
                input.click();
            }

            generateHTML() {
                const html = this.buildCompleteHTML();
                
                // Create download link
                const blob = new Blob([html], { type: 'text/html' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `${document.getElementById('templateTitle').value || 'newsletter'}.html`;
                link.click();
                
                URL.revokeObjectURL(url);
                this.showNotification('HTML generiert und heruntergeladen');
            }

            copyHTML() {
                const html = this.buildCompleteHTML();
                this.currentHTML = html;
                
                // Copy to clipboard
                navigator.clipboard.writeText(html).then(() => {
                    // Show modal with preview
                    document.getElementById('htmlPreview').textContent = html;
                    document.getElementById('copyHTMLModal').style.display = 'block';
                    document.getElementById('overlay').style.display = 'block';
                    
                    this.showNotification('HTML in Zwischenablage kopiert!', false, 'success');
                }).catch(err => {
                    console.error('Fehler beim Kopieren:', err);
                    // Fallback: Show in modal for manual copy
                    document.getElementById('htmlPreview').textContent = html;
                    document.getElementById('copyHTMLModal').style.display = 'block';
                    document.getElementById('overlay').style.display = 'block';
                    
                    this.showNotification('Bitte kopieren Sie den HTML-Code manuell', true);
                });
            }

            copyHTMLAgain() {
                navigator.clipboard.writeText(this.currentHTML).then(() => {
                    this.showNotification('HTML erneut kopiert!', false, 'success');
                }).catch(err => {
                    this.showNotification('Bitte markieren und kopieren Sie den Code manuell', true);
                });
            }

            closeCopyHTML() {
                document.getElementById('copyHTMLModal').style.display = 'none';
                document.getElementById('overlay').style.display = 'none';
            }

            buildCompleteHTML() {
                let html = `<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>${document.getElementById('templateTitle').value || 'Newsletter'}</title>
    <style type="text/css">
        body { margin: 0; padding: 0; font-family: 'GT Walsheim', Arial, sans-serif; }
        table { border-collapse: collapse; }
        td { padding: 0; }
        img { border: 0; display: block; }
    </style>
</head>
<body style="margin: 0; padding: 0; background-color: #f5f5f5;">
    <center>
        <table border="0" cellpadding="0" cellspacing="0" width="100%" style="background-color: #f5f5f5;">
            <tr>
                <td align="center" valign="top">`;
                
                this.modules.forEach(module => {
                    html += this.renderModuleContent(module);
                });
                
                html += `
                </td>
            </tr>
        </table>
    </center>
</body>
</html>`;
                
                return html;
            }

            showPreview() {
                const html = this.buildCompleteHTML();
                const iframe = document.getElementById('previewFrame');
                
                iframe.srcdoc = html;
                document.getElementById('previewModal').style.display = 'block';
                document.getElementById('overlay').style.display = 'block';
            }

            closePreview() {
                document.getElementById('previewModal').style.display = 'none';
                document.getElementById('overlay').style.display = 'none';
            }

            autoSave() {
                const autoSaveData = {
                    name: document.getElementById('templateTitle').value,
                    modules: this.modules,
                    savedAt: new Date().toISOString()
                };
                
                localStorage.setItem('swafTemplateAutoSave', JSON.stringify(autoSaveData));
            }

            loadAutoSave() {
                const autoSaveData = localStorage.getItem('swafTemplateAutoSave');
                
                if (autoSaveData) {
                    try {
                        const data = JSON.parse(autoSaveData);
                        
                        if (confirm('Es wurde eine automatisch gespeicherte Version gefunden. Möchten Sie diese laden?')) {
                            this.loadTemplateData(data);
                        }
                    } catch (error) {
                        console.error('Error loading autosave:', error);
                    }
                }
            }

            showNotification(message, isError = false, type = null) {
                const notification = document.createElement('div');
                notification.className = 'notification';
                
                if (isError) {
                    notification.className += ' error';
                } else if (type === 'success') {
                    notification.className += ' success';
                }
                
                notification.textContent = message;
                
                document.body.appendChild(notification);
                
                setTimeout(() => {
                    notification.remove();
                }, 3000);
            }
        }

        // Initialize the application
        const templateBuilder = new TemplateBuilder();
    </script>
</body>
</html>
